$NoPrefix
Option Explicit
'On Error GoTo ERRORHANDLE
Randomize Using Timer
Screen NewImage(641, 481, 32) '40x30
PrintMode KeepBackground
DisplayOrder Hardware , Software
Title "TerraQuest"

'$include: 'Assets\Sources\VariableDeclaration.bi'

'$include: 'Assets\Sources\DefaultValues.bi'

'$include: 'Assets\Sources\TileIndex.bi'

'$include: 'Assets\Sources\InventoryIndex.bi'

'$include: 'Assets\Sources\CreativeInventory.bi'

Rem'$include: 'Assets\Sources\CraftingIndex.bi'

Const MaxCraftLevel = 5
Dim Shared CursorHoverX, CursorHoverY, CursorHoverPage, CursorSelectedX, CursorSelectedY, CursorSelectedPage, CursorMode

INITIALIZE
'TEMPORARY, MAKE A MENU SUBROUTINE OR SOMETHING
CENTERPRINT "Temporary title screen"
Print
Dim InputString As String
Input "(L)oad world, (C)reate new world: ", InputString
If LCase$(InputString) = "l" Then
    Input "World name"; WorldName
    LOADWORLD
End If
If LCase$(InputString) = "c" Then NewWorld
For i = 0 To 31
    For ii = 0 To 41
        UpdateTile ii, i
    Next
Next
SpreadLight (1)
GoTo game

Error 102

ERRORHANDLE: ErrorHandler
DisplayOrder GLRender , Hardware , Software
game:
SwitchRender 0 'these 2 statements are important to prevent a dumb bug
SwitchRender 1
Do

    OnTopEffect
    Effects 0, ""
    SetBG
    SetMap
    CastShadow
    Move
    COLDET
    SPSET
    SetLighting
    INTER
    If KeyDown(15360) = 0 Then Hud2
    If KeyDown(15360) Then HUD


    ZOOM
    DEV
    ChangeMap 0, 0, 0
    DayLightCycle
    MinMemFix

    If Player.health <= 0 Then Respawn
    If TileIndexData(WallTile(FacingX, FacingY), 8) > 0 Then Player.CraftingLevel = TileIndexData(WallTile(FacingX, FacingY), 8) Else Player.CraftingLevel = 2

    KeyPressed = KeyHit
    If Flag.FrameRateLock = 0 Then Limit Settings.FrameRate
    CurrentTick = CurrentTick + Settings.TickRate
    If Flag.ScreenRefreshSkip = 0 Then Display
    Flag.ScreenRefreshSkip = 0
    If Flag.OpenCommand = 1 Then
        DisplayOrder Hardware , Software
        Flag.OpenCommand = 2
    End If
    If Flag.OpenCommand = 0 Then DisplayOrder GLRender , Hardware , Software
    Cls
Loop

Error 102

Sub Respawn
    SAVEMAP
    Player.x = SpawnPointX
    Player.y = SpawnPointY
    SavedMapX = SpawnMapX
    SavedMapY = SpawnMapY
    LOADMAP SavedMap
    Player.health = 8
End Sub

Sub UseHotBar
    Static As Byte iii
    Static As Byte flashtimeout
    Static As Integer64 hbtimeout
    Dim As Single HotbarX, HotbarY, HotbarSpace
    Dim As Single ItemSizeOffset

    HotbarX = (ScreenRezX / 4 / 2) - 9
    HotbarY = (ScreenRezY / 4 / 2) + 7
    HotbarSpace = 17
    ItemSizeOffset = 2


    If Flag.InventoryOpen = 0 Then

        If Item1 Then
            UseItem 0
            iii = 0
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If Item2 Then
            UseItem 1
            iii = 1
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If Item3 Then
            UseItem 2
            iii = 2
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If Item4 Then
            UseItem 3
            iii = 3
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If Item5 Then
            UseItem 4
            iii = 4
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If Item6 Then
            UseItem 5
            iii = 5
            hbtimeout = CurrentTick + 10
            flashtimeout = 5
        End If
        If hbtimeout > CurrentTick And flashtimeout > 0 Then PutImage (CameraPositionX - HotbarX + (HotbarSpace * iii), CameraPositionY + HotbarY - 16)-(CameraPositionX - HotbarX + 16 + (HotbarSpace * iii), CameraPositionY + HotbarY), Texture.HudSprites, , (32, 32)-(63, 63) Else hbtimeout = CurrentTick + 3: flashtimeout = flashtimeout - 1
        If flashtimeout < 0 Then flashtimeout = 0

    End If
End Sub


Sub DisplayLables
    Dim As Byte i, ii, iii, iiii
    Dim As Single HealthTextX, HealthTextY
    Dim As Single HotbarTextX, HotbarTextY, HotbarTextSpace
    Dim As Single HotbarTitlex, HotbarTitley
    Dim As Single InventoryTitleX, InventoryTitleY
    Dim As Single InventoryTextOffset
    Dim As Single CraftingTextX, CraftingTextY
    Dim As Single CraftingTitleX, CraftingTitleY

    InventoryTextOffset = 83

    HealthTextX = ScreenRezX - 60
    HealthTextY = 0

    HotbarTextX = 5
    HotbarTextY = ScreenRezY - 61
    HotbarTextSpace = 68

    HotbarTitlex = 6
    HotbarTitley = ScreenRezY - 85

    InventoryTitleX = 6
    InventoryTitleY = ScreenRezY - 305

    CraftingTextX = ScreenRezX - 66
    CraftingTextY = ScreenRezY + 23


    Color RGB(0, 0, 0)
    For i = 0 To 2
        For ii = 0 To 2

            PrintString (HealthTextX + (i - 1), HealthTextY + (ii - 1)), "Health:"
            PrintString (HotbarTitlex + (i - 1), HotbarTitley + (ii - 1)), "Hotbar:"
            If Flag.InventoryOpen = 1 Then
                PrintString (InventoryTitleX + (i - 1), InventoryTitleY + (ii - 1)), "Inventory:"
                'PrintString (Craftingtitlex + (i - 1), CraftingTitleY + (ii - 1)), "Crafting:"
            End If

            For iii = 0 To 5
                If Inventory(0, iii, 7) > 1 Then PrintString ((HotbarTextX) + (HotbarTextSpace * iii) + i - 1, HotbarTextY + ii - 1), Str$(Inventory(0, iii, 7))
                For iiii = 0 To 2
                    If Flag.InventoryOpen = 1 And GameMode <> 1 Then PrintString ((0 + HotbarTextX) + (HotbarTextSpace * iii) + i - 1, (HotbarTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset + ii - 1), Str$(Inventory(iiii + 1, iii, 7))
                    'And Inventory(iiii + 1, iii, 7) > 1
                Next
            Next
            For iii = Player.CraftingLevel - 1 To 0 Step -1
                For iiii = Player.CraftingLevel - 1 To 0 Step -1
                    If Flag.InventoryOpen = 1 Then PrintString ((0 + CraftingTextX) - (HotbarTextSpace * iii) + i - 1, (CraftingTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset + ii - 1), Str$(CraftingGrid(iiii, iii, 7))
                    'And CraftingGrid(iiii, iii, 7) > 1
                Next
            Next
            iiii = 0
            iii = Player.CraftingLevel
            If Flag.InventoryOpen = 1 And CraftingGrid(iiii, iii, 7) > 1 Then PrintString ((0 + CraftingTextX) - (HotbarTextSpace * iii) + i - 1, (CraftingTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset + ii - 1), Str$(CraftingGrid(iiii, iii, 7))
        Next
    Next

    Color RGB(255, 255, 255)

    PrintString (HealthTextX, HealthTextY), "Health:"
    PrintString (HotbarTitlex, HotbarTitley), "Hotbar:"
    If Flag.InventoryOpen = 1 Then PrintString (InventoryTitleX, InventoryTitleY), "Inventory:"
    'PrintString (Craftingtitlex + (i - 1), CraftingTitleY + (ii - 1)), "Crafting:"
    For iii = 0 To 5

        If Inventory(0, iii, 7) > 1 Then PrintString ((HotbarTextX) + (HotbarTextSpace * iii), HotbarTextY), Str$(Inventory(0, iii, 7))
        For iiii = 0 To 2
            If Flag.InventoryOpen = 1 And Inventory(iiii + 1, iii, 7) > 1 And GameMode <> 1 Then PrintString ((HotbarTextX) + (HotbarTextSpace * iii), (HotbarTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset), Str$(Inventory(iiii + 1, iii, 7))
        Next

    Next
    For iii = Player.CraftingLevel - 1 To 0 Step -1
        For iiii = Player.CraftingLevel - 1 To 0 Step -1
            If Flag.InventoryOpen = 1 And CraftingGrid(iiii, iii, 7) > 1 Then PrintString ((0 + CraftingTextX) - (HotbarTextSpace * iii), (CraftingTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset), Str$(CraftingGrid(iiii, iii, 7))
        Next
    Next
    iiii = 0
    iii = Player.CraftingLevel
    If Flag.InventoryOpen = 1 And CraftingGrid(iiii, iii, 7) > 1 Then PrintString ((0 + CraftingTextX) - (HotbarTextSpace * iii), (CraftingTextY) - (HotbarTextSpace * iiii + 1) - InventoryTextOffset), Str$(CraftingGrid(iiii, iii, 7))
End Sub

Sub DisplayHealth
    Dim As Byte i, ii, iii
    Dim As Byte Token, TMPHeal
    Dim As Single HealthX, HealthY
    Token = 1
    HealthX = (ScreenRezX / 4 / 2) + 8
    HealthY = (ScreenRezY / 4 / 2) - 11

    TMPHeal = Player.health

    Select Case GameMode
        Case 1
            PutImage (CameraPositionX + HealthX - 16, CameraPositionY - HealthY + (Token - 1) * 16)-(CameraPositionX + HealthX, CameraPositionY - HealthY + 16 + (Token - 1) * 16), Texture.HudSprites, , (4 * 32, 32)-(4 * 32 + 31, 63)
        Case 2
            While TMPHeal > 0
                If TMPHeal <= 8 Then
                    PutImage (CameraPositionX + HealthX - 16, CameraPositionY - HealthY + (Token - 1) * 16)-(CameraPositionX + HealthX, CameraPositionY - HealthY + 16 + (Token - 1) * 16), Texture.HudSprites, , ((TMPHeal - 1) * 32, 0)-((TMPHeal - 1) * 32 + 31, 31)
                Else
                    PutImage (CameraPositionX + HealthX - 16, CameraPositionY - HealthY + (Token - 1) * 16)-(CameraPositionX + HealthX, CameraPositionY - HealthY + 16 + (Token - 1) * 16), Texture.HudSprites, , (7 * 32, 0)-(7 * 32 + 31, 31)
                End If
                TMPHeal = TMPHeal - 8
                Token = Token + 1
            Wend
    End Select
End Sub

Sub DisplayHotbar
    Dim As Byte i, ii, iii
    Dim As Single HotbarX, HotbarY, HotbarSpace
    Dim As Single ItemSizeOffset
    HotbarX = (ScreenRezX / 4 / 2) - 9
    HotbarY = (ScreenRezY / 4 / 2) + 7
    HotbarSpace = 17
    ItemSizeOffset = 2

    For iii = 0 To 5
        PutImage (CameraPositionX - HotbarX + (HotbarSpace * iii), CameraPositionY + HotbarY - 16)-(CameraPositionX - HotbarX + 16 + (HotbarSpace * iii), CameraPositionY + HotbarY), Texture.HudSprites, , (0, 32)-(31, 63)
        PutImage (CameraPositionX - HotbarX + (HotbarSpace * iii) + ItemSizeOffset, CameraPositionY + HotbarY - 16 + ItemSizeOffset)-(CameraPositionX - HotbarX + 16 + (HotbarSpace * iii) - ItemSizeOffset, CameraPositionY + HotbarY - ItemSizeOffset), Texture.ItemSheet, , (Inventory(0, iii, 1), Inventory(0, iii, 2))-(Inventory(0, iii, 1) + 15, Inventory(0, iii, 2) + 15)
        If Flag.InventoryOpen = 1 Then
            If CursorHoverPage = 1 And CursorHoverX = iii Then PutImage (CameraPositionX - HotbarX + (HotbarSpace * iii), CameraPositionY + HotbarY - 16)-(CameraPositionX - HotbarX + 16 + (HotbarSpace * iii), CameraPositionY + HotbarY), Texture.HudSprites, , (32, 32)-(63, 63)
            If CursorSelectedPage = 1 And CursorSelectedX = iii And CursorMode = 1 Then PutImage (CameraPositionX - HotbarX + (HotbarSpace * iii), CameraPositionY + HotbarY - 16)-(CameraPositionX - HotbarX + 16 + (HotbarSpace * iii), CameraPositionY + HotbarY), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)
        End If
    Next

End Sub

Sub DisplayInventory (CreativePage As Integer)
    Dim As Byte i, ii, iii, iiii
    Dim As Single InventoryX, InventoryY, InventorySpace, InventoryOffset
    Dim As Single itemsizeoffset

    InventoryX = (ScreenRezX / 4 / 2) - 9
    InventoryY = (ScreenRezY / 4 / 2) + 2
    InventorySpace = 17
    InventoryOffset = 1
    itemsizeoffset = 2


    For iii = 0 To 5
        For iiii = 0 To 2
            PutImage (CameraPositionX - InventoryX + (InventorySpace * iii), (CameraPositionY + InventoryY - 16) - (16 * (iiii + 1) + InventoryOffset * iiii))-(CameraPositionX - InventoryX + 16 + (17 * iii), (CameraPositionY + InventoryY) - (16 * (iiii + 1) + InventoryOffset * iiii)), Texture.HudSprites, , (0, 32)-(31, 63)
            If CursorHoverPage = 0 And CursorHoverX = iii And CursorHoverY = iiii Then PutImage (CameraPositionX - InventoryX + (InventorySpace * iii), (CameraPositionY + InventoryY - 16) - (16 * (iiii + 1) + InventoryOffset * iiii))-(CameraPositionX - InventoryX + 16 + (17 * iii), (CameraPositionY + InventoryY) - (16 * (iiii + 1) + InventoryOffset * iiii)), Texture.HudSprites, , (32, 32)-(63, 63)
            If CursorSelectedPage = 0 And CursorSelectedX = iii And CursorSelectedY = iiii And CursorMode = 1 Then PutImage (CameraPositionX - InventoryX + (InventorySpace * iii), (CameraPositionY + InventoryY - 16) - (16 * (iiii + 1) + InventoryOffset * iiii))-(CameraPositionX - InventoryX + 16 + (17 * iii), (CameraPositionY + InventoryY) - (16 * (iiii + 1) + InventoryOffset * iiii)), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)


            Select Case GameMode
                Case 1
                    PutImage (CameraPositionX - InventoryX + (InventorySpace * iii) + itemsizeoffset, (CameraPositionY + InventoryY - 16) - (16 * (iiii + 1) + InventoryOffset * iiii) + itemsizeoffset)-(CameraPositionX - InventoryX + 16 + (17 * iii) - itemsizeoffset, (CameraPositionY + InventoryY) - (16 * (iiii + 1) + InventoryOffset * iiii) - itemsizeoffset), Texture.ItemSheet, , (CreativeInventory(iiii, iii, 1, CreativePage), CreativeInventory(iiii, iii, 2, CreativePage))-(CreativeInventory(iiii, iii, 1, CreativePage) + 15, CreativeInventory(iiii, iii, 2, CreativePage) + 15)

                Case 2
                    PutImage (CameraPositionX - InventoryX + (InventorySpace * iii) + itemsizeoffset, (CameraPositionY + InventoryY - 16) - (16 * (iiii + 1) + InventoryOffset * iiii) + itemsizeoffset)-(CameraPositionX - InventoryX + 16 + (17 * iii) - itemsizeoffset, (CameraPositionY + InventoryY) - (16 * (iiii + 1) + InventoryOffset * iiii) - itemsizeoffset), Texture.ItemSheet, , (Inventory(iiii + 1, iii, 1), Inventory(iiii + 1, iii, 2))-(Inventory(iiii + 1, iii, 1) + 15, Inventory(iiii + 1, iii, 2) + 15)
            End Select
        Next
    Next

End Sub

Sub DisplayCrafting
    Dim i, ii, iii, iiii
    Dim As Single CraftingX, CraftingY, CraftingSpace, CraftingOffset, CraftingResultX, CraftingResultY
    Dim As Single ItemSizeOffset

    '5    Player.CraftingLevel = 4
    ItemSizeOffset = 2
    CraftingX = (ScreenRezX / 4 / 2) - 9
    CraftingY = (ScreenRezY / 4 / 2) - 9
    CraftingSpace = 17
    CraftingOffset = 1

    Crafting

    Select Case Player.CraftingLevel
        Case 0 TO 5
            For iii = 0 To Player.CraftingLevel - 1
                For iiii = 0 To Player.CraftingLevel - 1
                    PutImage (CameraPositionX + CraftingX - (CraftingSpace * iii), CameraPositionY + CraftingY - (CraftingSpace * iiii))-(CameraPositionX + CraftingX - (CraftingSpace * iii) + 16, CameraPositionY + CraftingY - (CraftingSpace * iiii) + 16), Texture.HudSprites, , (0, 32)-(31, 63)
                    PutImage (CameraPositionX + CraftingX - (CraftingSpace * iii) + ItemSizeOffset, CameraPositionY + CraftingY - (CraftingSpace * iiii) + ItemSizeOffset)-(CameraPositionX + CraftingX - (CraftingSpace * iii) + 16 - ItemSizeOffset, CameraPositionY + CraftingY - (CraftingSpace * iiii) + 16 - ItemSizeOffset), Texture.ItemSheet, , (CraftingGrid(iiii, iii, 1), CraftingGrid(iiii, iii, 2))-(CraftingGrid(iiii, iii, 1) + 15, CraftingGrid(iiii, iii, 2) + 15)

                    If CursorHoverPage = 3 And CursorHoverX = iii And CursorHoverY = iiii Then PutImage (CameraPositionX + CraftingX - (CraftingSpace * iii), CameraPositionY + CraftingY - (CraftingSpace * iiii))-(CameraPositionX + CraftingX - (CraftingSpace * iii) + 16, CameraPositionY + CraftingY - (CraftingSpace * iiii) + 16), Texture.HudSprites, , (32, 32)-(63, 63)
                    If CursorSelectedPage = 3 And CursorSelectedX = iii And CursorSelectedY = iiii And CursorMode = 1 Then PutImage (CameraPositionX + CraftingX - (CraftingSpace * iii), CameraPositionY + CraftingY - (CraftingSpace * iiii))-(CameraPositionX + CraftingX - (CraftingSpace * iii) + 16, CameraPositionY + CraftingY - (CraftingSpace * iiii) + 16), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)

                Next
            Next

            PutImage (CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)), CameraPositionY + CraftingY)-(CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)) + 16, CameraPositionY + CraftingY + 16), Texture.HudSprites, , (0, 32)-(31, 63)
            PutImage (CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)) + ItemSizeOffset, CameraPositionY + CraftingY + ItemSizeOffset)-(CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)) + 16 - ItemSizeOffset, CameraPositionY + CraftingY + 16 - ItemSizeOffset), Texture.ItemSheet, , (CraftingGrid(0, Player.CraftingLevel, 1), CraftingGrid(0, Player.CraftingLevel, 2))-(CraftingGrid(0, Player.CraftingLevel, 1) + 15, CraftingGrid(0, Player.CraftingLevel, 2) + 15)

            If CursorHoverPage = 3 And CursorHoverX = Player.CraftingLevel Then PutImage (CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)), CameraPositionY + CraftingY)-(CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)) + 16, CameraPositionY + CraftingY + 16), Texture.HudSprites, , (32, 32)-(63, 63)
            If CursorSelectedPage = 3 And CursorSelectedX = Player.CraftingLevel And CursorMode = 1 Then PutImage (CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)), CameraPositionY + CraftingY)-(CameraPositionX + CraftingX - (CraftingSpace * (Player.CraftingLevel)) + 16, CameraPositionY + CraftingY + 16), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)


    End Select
End Sub

Sub DisplayContainer
End Sub


Sub NewStack (ItemID, StackNumber)
    Dim i, ii, iii
    Select Case CursorHoverPage


        Case 0 And 1
            For i = 0 To 3
                For ii = 0 To 5
                    If Inventory(i, ii, 9) = -1 Then
                        For iii = 0 To 9
                            Inventory(i, ii, iii) = ItemIndex(ItemID, iii)
                        Next
                        Inventory(i, ii, 7) = StackNumber
                        GoTo Complete
                    End If
                Next
            Next
            For i = 0 To 3
                For ii = 0 To 5
                    If Inventory(i, ii, 9) = -1 Then
                        For iii = 0 To 9
                            Inventory(i, ii, iii) = ItemIndex(ItemID, iii)
                        Next
                        Inventory(i, ii, 7) = StackNumber
                        GoTo Complete
                    End If
                Next
            Next

        Case 2
        Case 3
            'no splitting in craftingUI
    End Select
    Complete:
End Sub

Sub ItemSwap
    Dim As Byte i, ii, iii, CraftComplete
    Dim SwapItem1(InvParameters), Swapitem2(InvParameters)

    'set the empty slots to -1
    For i = 0 To InvParameters
        SwapItem1(i) = -1
        Swapitem2(i) = -1
    Next


    'Put the source and destination in to dummy arrays to make it easier to work with
    For i = 0 To InvParameters
        Select Case CursorSelectedPage
            Case 0
                Swapitem2(i) = Inventory(CursorSelectedY + 1, CursorSelectedX, i)
            Case 1
                Swapitem2(i) = Inventory(0, CursorSelectedX, i)
            Case 3
                Swapitem2(i) = CraftingGrid(CursorSelectedY, CursorSelectedX, i)

        End Select

        Select Case CursorHoverPage
            Case 0
                SwapItem1(i) = Inventory(CursorHoverY + 1, CursorHoverX, i)
            Case 1
                SwapItem1(i) = Inventory(0, CursorHoverX, i)
            Case 3
                SwapItem1(i) = CraftingGrid(CursorHoverY, CursorHoverX, i)


        End Select
    Next

    'check and see if it involves the crafting table result
    If CursorHoverPage = 3 Then
        If CursorHoverX = Player.CraftingLevel Then
            If Swapitem2(0) <> -1 Then Exit Sub Else CraftComplete = 1
        End If
    End If
    If CursorSelectedPage = 3 Then
        If CursorSelectedX = Player.CraftingLevel Then
            If SwapItem1(0) <> -1 Then Exit Sub Else CraftComplete = 1
        End If
    End If

    'swap the items, or stack if able
    If SwapItem1(9) = Swapitem2(9) Then
        SwapItem1(7) = SwapItem1(7) + Swapitem2(7)
        Swapitem2(7) = 0

        If SwapItem1(7) > SwapItem1(8) Then
            Swapitem2(7) = Swapitem2(7) + (SwapItem1(7) - SwapItem1(8))
            SwapItem1(7) = SwapItem1(8)
        End If

        If Swapitem2(7) = 0 Then
            For ii = 0 To InvParameters
                Swapitem2(ii) = -1
            Next
        End If

    Else
        For i = 0 To InvParameters
            Swap SwapItem1(i), Swapitem2(i)
        Next
    End If


    'rewrite the dummy variables to the source and dest
    For i = 0 To InvParameters


        Select Case CursorSelectedPage
            Case 0
                Inventory(CursorSelectedY + 1, CursorSelectedX, i) = Swapitem2(i)
            Case 1
                Inventory(0, CursorSelectedX, i) = Swapitem2(i)
            Case 3
                CraftingGrid(CursorSelectedY, CursorSelectedX, i) = Swapitem2(i)


        End Select

        Select Case CursorHoverPage
            Case 0
                Inventory(CursorHoverY + 1, CursorHoverX, i) = SwapItem1(i)
            Case 1
                Inventory(0, CursorHoverX, i) = SwapItem1(i)
            Case 3
                CraftingGrid(CursorHoverY, CursorHoverX, i) = SwapItem1(i)

        End Select
    Next

    'if the result was pulled from the crafting table, remove the table items
    If CraftComplete = 1 Then
        CraftComplete = 0
        For i = 0 To Player.CraftingLevel - 1
            For ii = 0 To Player.CraftingLevel - 1
                CraftingGrid(ii, i, 7) = CraftingGrid(ii, i, 7) - 1
                If CraftingGrid(ii, i, 7) <= 0 Then

                    For iii = 0 To InvParameters
                        CraftingGrid(ii, i, iii) = -1
                    Next
                End If
            Next
        Next
    End If
End Sub



Sub EmptySlot (slot, row)
    Dim i
    For i = 0 To InvParameters
        Inventory(row, slot, i) = -1
    Next
End Sub

Sub InputCursor
    Dim As Byte i, ii, iii

    If InventorySelect Then
        If CursorMode = 0 Then
            CursorSelectedX = CursorHoverX
            CursorSelectedY = CursorHoverY
            CursorSelectedPage = CursorHoverPage
            CursorMode = 1
        ElseIf CursorMode = 1 Then
            CursorMode = 0
            ItemSwap
        End If
    End If

    If InventoryTab Then
        CursorHoverPage = CursorHoverPage + 1
        If Flag.ContainerOpen = 0 And CursorHoverPage = 2 Then CursorHoverPage = 3
        If Flag.ContainerOpen = 0 And CursorSelectedPage = 2 Then CursorMode = 0
        If CursorHoverPage > 3 Then CursorHoverPage = 0
    End If

    If InventorySplit Then
        Select Case CursorHoverPage
            Case 0
                If Inventory(CursorHoverY + 1, CursorHoverX, 7) > 1 Then
                    NewStack Inventory(CursorHoverY + 1, CursorHoverX, 9), Int(Inventory(CursorHoverY + 1, CursorHoverX, 7) / 2)
                    Inventory(CursorHoverY + 1, CursorHoverX, 7) = Ceil(Inventory(CursorHoverY + 1, CursorHoverX, 7) / 2)
                End If
        End Select
    End If

    If InventoryUp Then
        CursorHoverY = CursorHoverY + 1

    End If
    If InventoryDown Then
        CursorHoverY = CursorHoverY - 1

    End If
    If InventoryLeft Then
        CursorHoverX = CursorHoverX - 1
        If CursorHoverPage = 3 Then CursorHoverX = CursorHoverX + 2
    End If
    If InventoryRight Then
        CursorHoverX = CursorHoverX + 1
        If CursorHoverPage = 3 Then CursorHoverX = CursorHoverX - 2
    End If
    If InventoryUse And CursorHoverPage = 1 Then
        UseItem CursorHoverX
    End If

    Select Case CursorHoverPage
        Case 0 'Inventory
            If CursorHoverX > 5 Then CursorHoverX = 0
            If CursorHoverX < 0 Then CursorHoverX = 5
            If CursorHoverY > 2 Then CursorHoverY = 0
            If CursorHoverY < 0 Then CursorHoverY = 2
        Case 1 'Hotbar
            If CursorHoverX > 5 Then CursorHoverX = 0
            If CursorHoverX < 0 Then CursorHoverX = 5
            CursorHoverY = 0
        Case 2 'Container
        Case 3 'Crafting
            If CursorHoverX > Player.CraftingLevel Then CursorHoverX = 0
            If CursorHoverX < 0 Then CursorHoverX = Player.CraftingLevel
            If CursorHoverY > Player.CraftingLevel - 1 Then CursorHoverY = 0
            If CursorHoverY < 0 Then CursorHoverY = Player.CraftingLevel - 1
            If CursorHoverX = Player.CraftingLevel Then CursorHoverY = 0

    End Select



End Sub

Sub Hud2
    If Flag.HudDisplay = 0 Then
        Dim As Byte i, ii, iii, iiii
        Static CreativePage
        'Print CursorHoverPage, CursorHoverX, CursorHoverY

        DisplayHealth
        DisplayHotbar
        If Flag.InventoryOpen = 1 Then
            DisplayInventory CreativePage
            DisplayCrafting
            DisplayContainer
            InputCursor
        End If
        UseHotBar
        DisplayLables

    End If
End Sub
Sub Crafting
    Dim recipe As String
    Dim i, ii, iii As Byte

    For i = Player.CraftingLevel - 1 To 0 Step -1
        For ii = Player.CraftingLevel - 1 To 0 Step -1
            recipe = recipe + Trim$(Str$(CraftingGrid(i, ii, 9))) + " "
        Next
        recipe = recipe + "|"
    Next
    For i = 0 To InvParameters
        CraftingGrid(0, Player.CraftingLevel, i) = -1
    Next

    Select Case recipe
        Case "-1 -1 -1 |-1 5 -1 |-1 -1 -1 |" 'bush to raw wood
            For i = 0 To InvParameters
                CraftingGrid(0, Player.CraftingLevel, i) = ItemIndex(19, i)
            Next
            CraftingGrid(0, Player.CraftingLevel, 7) = 4
        Case "19 19 |19 19 |" 'crafting station
            For i = 0 To InvParameters
                CraftingGrid(0, Player.CraftingLevel, i) = ItemIndex(21, i)
            Next
        Case "-1 -1 -1 |-1 5 -1 |19 19 19 |" 'Campfire
            For i = 0 To InvParameters
                CraftingGrid(0, Player.CraftingLevel, i) = ItemIndex(10, i)
            Next
    End Select
    Print recipe
End Sub

Sub ClearTable
    Dim i, ii, iii As Byte
    For i = 0 To InvParameters
        For ii = 0 To 5
            For iii = 0 To 5
                CraftingGrid(i, ii, iii) = -1
            Next
        Next
    Next
End Sub

Function CraftSpace (level)
    Select Case level
        Case 0
            CraftSpace = 8.5
        Case 1
            CraftSpace = 0
    End Select
End Function

Function Item1
    Item1 = KeyDown(49)
End Function

Function Item2
    Item2 = KeyDown(50)
End Function

Function Item3
    Item3 = KeyDown(51)
End Function

Function Item4
    Item4 = KeyDown(52)
End Function

Function Item5
    Item5 = KeyDown(53)
End Function

Function Item6
    Item6 = KeyDown(54)
End Function



Function MoveUp
    MoveUp = KeyDown(119)
End Function

Function MoveDown
    MoveDown = KeyDown(115)
End Function

Function MoveLeft
    MoveLeft = KeyDown(97)
End Function

Function MoveRight
    MoveRight = KeyDown(100)
End Function


Function InventoryUp
    Static SingleHit As Byte
    If KeyDown(18432) And SingleHit <> 1 Then
        InventoryUp = KeyDown(18432)
        SingleHit = 1
    5 ElseIf KeyDown(18432) = 0 Then SingleHit = 0
    End If


End Function

Function InventoryDown
    Static SingleHit As Byte
    If KeyDown(20480) And SingleHit <> 1 Then
        InventoryDown = KeyDown(20480)
        SingleHit = 1
    ElseIf KeyDown(20480) = 0 Then SingleHit = 0
    End If
End Function

Function InventoryLeft
    Static SingleHit As Byte
    If KeyDown(19200) And SingleHit <> 1 Then
        InventoryLeft = KeyDown(19200)
        SingleHit = 1
    ElseIf KeyDown(19200) = 0 Then SingleHit = 0
    End If
End Function

Function InventoryRight
    Static SingleHit As Byte
    If KeyDown(19712) And SingleHit <> 1 Then
        InventoryRight = KeyDown(19712)
        SingleHit = 1
    ElseIf KeyDown(19712) = 0 Then SingleHit = 0
    End If


End Function

Function InventoryTab
    Static SingleHit As Byte
    If KeyDown(9) And SingleHit <> 1 Then
        InventoryTab = KeyDown(9)
        SingleHit = 1
    ElseIf KeyDown(9) = 0 Then SingleHit = 0
    End If
End Function

Function InventorySelect
    Static SingleHit As Byte
    If KeyDown(13) And SingleHit <> 1 Then
        InventorySelect = KeyDown(13)
        SingleHit = 1
    ElseIf KeyDown(13) = 0 Then SingleHit = 0
    End If
End Function
Function InventorySplit
    Static SingleHit As Byte
    If KeyDown(92) And SingleHit <> 1 Then
        InventorySplit = KeyDown(92)
        SingleHit = 1
    ElseIf KeyDown(92) = 0 Then SingleHit = 0
    End If
End Function

Function InventoryUse
    InventoryUse = KeyDown(32)
End Function




Sub SPSET
    Static anim As Byte
    Select Case Player.facing
        Case 0
            If Player.movingy = 1 Then
                If anim < 15 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (0, 0)-(15, 17 - SwimOffset)
                If anim > 14 And anim < 30 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 0)-(31, 17 - SwimOffset)
                If anim > 29 And anim < 45 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (32, 0)-(47, 17 - SwimOffset)
                If anim > 44 And anim < 60 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 0)-(31, 17 - SwimOffset)
            Else
                PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 0)-(31, 17 - SwimOffset)
            End If
        Case 1
            If Player.movingy = 1 Then
                If anim < 15 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (0, 36)-(15, 54 - SwimOffset)
                If anim > 14 And anim < 30 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 36)-(31, 53 - SwimOffset)
                If anim > 29 And anim < 45 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (32, 36)-(47, 53 - SwimOffset)
                If anim > 44 And anim < 60 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 36)-(31, 53 - SwimOffset)
            Else
                PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 36)-(31, 53 - SwimOffset)
            End If

        Case 2
            If Player.movingx = 1 Then
                If anim < 15 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (0, 54)-(15, 71 - SwimOffset)
                If anim > 14 And anim < 30 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 54)-(31, 71 - SwimOffset)
                If anim > 29 And anim < 45 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (32, 54)-(47, 71 - SwimOffset)
                If anim > 44 And anim < 60 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 54)-(31, 71 - SwimOffset)
            Else
                PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 54)-(31, 71 - SwimOffset)
            End If

        Case 3
            If Player.movingx = 1 Then
                If anim < 15 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (0, 18)-(15, 35 - SwimOffset)
                If anim > 14 And anim < 30 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 18)-(31, 35 - SwimOffset)
                If anim > 29 And anim < 45 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (32, 18)-(47, 35 - SwimOffset)
                If anim > 44 And anim < 60 Then PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 18)-(31, 35 - SwimOffset)
            Else
                PutImage (Int(Player.x), Int(Player.y + SwimOffset) - 2)-((Int(Player.x)) + 16, (Int(Player.y) - 2) + 16), Texture.PlayerSprites, , (16, 18)-(31, 35 - SwimOffset)
            End If
    End Select

    anim = anim + Settings.TickRate
    If KeyDown(100306) = 0 Then anim = anim + Settings.TickRate
    If anim > 59 Then anim = 0
End Sub

Function WithinBounds
    If Player.x > 0 And Player.y > 0 And Player.x < 640 - 16 And Player.y < 480 - 16 Then WithinBounds = 1 Else WithinBounds = 0
End Function

Sub ContactEffect (Direction As Byte)
    If WithinBounds = 1 Then
        Select Case Direction
            Case 1
                Effects 1, "Contact " + TileName(WallTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 - 16) / 16) + 1), 0)
                'Print "Contact " + TileName(WallTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 - 16) / 16) + 1), 0)
            Case 2
                Effects 1, "Contact " + TileName(WallTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 + 16) / 16) + 1), 0)
                'Print "Contact " + TileName(WallTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 + 16) / 16) + 1), 0)
            Case 3
                Effects 1, "Contact " + TileName(WallTile(Int((Player.x + 8 - 16) / 16) + 1, Int((Player.y + 8) / 16) + 1), 0)
                'Print "Contact " + TileName(WallTile(Int((Player.x + 8 - 16) / 16) + 1, Int((Player.y + 8) / 16) + 1), 0)
            Case 4
                Effects 1, "Contact " + TileName(WallTile(Int((Player.x + 8 + 16) / 16) + 1, Int((Player.y + 8) / 16) + 1), 0)
                'Print "Contact " + TileName(WallTile(Int((Player.x + 8 + 16) / 16) + 1, Int((Player.y + 8) / 16) + 1), 0)
        End Select
    End If
End Sub

Sub OnTopEffect
    If WithinBounds = 1 Then
        Effects 1, "OnTop " + TileName(GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1), 0)
    End If
End Sub


Sub EffectExecute (ID As Integer, Val1 As Single)
    Select Case ID
        Case 1 'Instant Damage
            If GameMode <> 1 Then Player.health = Player.health - Val1
            PlaySound Sounds.damage_bush
        Case 2
            SwimOffset = Val1
    End Select


End Sub

Function EffectIndex (Sources As String, Value As Single)
    Select Case Sources
        Case "Contact Campfire"
            Select Case Value
                Case 0
                    EffectIndex = 1 'effectid
                Case 1
                    EffectIndex = 2 'frame duration
                Case 2
                    EffectIndex = 15 'frame cooldown
                Case 3
                    EffectIndex = 2 'damage
            End Select

        Case "Contact Berry Bush"
            Select Case Value
                Case 0
                    EffectIndex = 1 'effectid
                Case 1
                    EffectIndex = 2 'frame duration
                Case 2
                    EffectIndex = 30 'frame cooldown
                Case 3
                    EffectIndex = 1 'damage
            End Select
        Case "OnTop Water"
            Select Case Value
                Case 0
                    EffectIndex = 2
                Case 1
                    EffectIndex = 2
                Case 2
                    EffectIndex = 0
                Case 3
                    EffectIndex = 7
            End Select
        Case Else
            EffectIndex = 0
    End Select
End Function

Sub EffectEnd (EffectID As Integer, EffectSlot As Integer)
    Dim i As Byte
    Select Case EffectID
        Case 1
            For i = 0 To EffectParameters
                EffectArray(EffectSlot, i) = 0
            Next
        Case 2
            For i = 0 To EffectParameters
                EffectArray(EffectSlot, i) = 0
            Next
            SwimOffset = 0
    End Select
End Sub

Sub Effects (Command As Byte, Sources As String)
    Dim As Byte i, ii
    Dim Null As Byte
    Dim EffectSources(MaxEffects) As String

    Select Case Command
        Case 0 'count down and execute effect
            For i = 0 To MaxEffects
                If EffectArray(i, 1) > 0 Then EffectArray(i, 1) = EffectArray(i, 1) - Settings.TickRate
                If EffectArray(i, 2) > 0 Then EffectArray(i, 2) = EffectArray(i, 2) - Settings.TickRate
                If EffectArray(i, 1) > 0 Then
                    EffectExecute EffectArray(i, 0), EffectArray(i, 3)
                End If
                If EffectArray(i, 1) <= 0 And EffectArray(i, 2) <= 0 Then
                    EffectEnd EffectArray(i, 0), i
                End If
            Next
        Case 1 ' apply new effect
            For i = 0 To MaxEffects
                If EffectArray(i, 0) = 0 Then
                    For ii = 0 To EffectParameters
                        EffectArray(i, ii) = EffectIndex(Sources, ii)
                    Next
                    Exit Case
                End If
                If EffectArray(i, 0) = EffectIndex(Sources, 0) Then
                    If EffectArray(i, 2) <= 0 Then
                        For ii = 0 To EffectParameters
                            EffectArray(i, ii) = EffectIndex(Sources, ii)
                        Next
                    End If
                    Exit Case
                End If
            Next
    End Select
End Sub





Sub Move
    Static SoundCooldown As Byte
    Player.movingx = 0 'sets to 0 and then if a key is being held, sets back to 1 before anyone notices
    Player.movingy = 0 'sets to 0 and then if a key is being held, sets back to 1 before anyone notices
    Player.lastx = Player.x 'these 2 are literally just for the freecammode
    Player.lasty = Player.y


    If MoveUp Then
        Player.vy = Player.vy - TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        Player.facing = 0
        Player.movingy = 1
    End If
    If MoveDown Then
        Player.vy = Player.vy + TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        Player.facing = 1
        Player.movingy = 1

    End If
    If MoveLeft Then
        Player.vx = Player.vx - TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        Player.facing = 2
        Player.movingx = 1
    End If
    If MoveRight Then
        Player.vx = Player.vx + TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        Player.facing = 3
        Player.movingx = 1
    End If

    If Player.vy > TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) Then Player.vy = TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10)
    If Player.vy < TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) - (TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) * 2) Then Player.vy = TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) - (TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) * 2)

    If Player.vx > TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) Then Player.vx = TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10)
    If Player.vx < TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) - (TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) * 2) Then Player.vx = TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) - (TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 10) * 2)

    If Player.movingy = 0 Then
        If Player.vy > 0 Then
            Player.vy = Player.vy - TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        End If
        If Player.vy < 0 Then
            Player.vy = Player.vy + TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
            If Player.vy > 0 Then Player.vy = 0
        End If
    End If
    If Player.movingx = 0 Then
        If Player.vx > 0 Then
            Player.vx = Player.vx - TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
        End If
        If Player.vx < 0 Then
            Player.vx = Player.vx + TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, 9)
            If Player.vx > 0 Then Player.vx = 0
        End If
    End If

    If Player.movingx = 1 Or Player.movingy = 1 Then SoundCooldown = SoundCooldown - 1

    If SoundCooldown <= 0 Then
        If WithinBounds = 1 Then
            If GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1) = 13 Then
                SoundCooldown = 60
                PlaySound Sounds.walk_water

            Else
                SoundCooldown = 15
                PlaySound Sounds.walk_grass
            End If
        End If
    End If

    Player.x = Player.x + Player.vx
    Player.y = Player.y + Player.vy

    'stops the player from going out of bounds
    If Player.x <= 0 Then Player.x = 0
    If Player.y <= 0 Then Player.y = 0
    If Player.x >= 640 - 16 Then Player.x = 640 - 16
    If Player.y >= 480 - 16 Then Player.y = 480 - 16

    'self explanitory, but if you must know its to control the camera in freecam mode
    If Flag.FreeCam = 1 Then
        Player.x = Player.lastx
        Player.y = Player.lasty
        If Player.movingx = 1 Or Player.movingy = 1 Then
            Select Case Player.facing
                Case 0
                    CameraPositionY = CameraPositionY - 1
                Case 1
                    CameraPositionY = CameraPositionY + 1
                Case 2
                    CameraPositionX = CameraPositionX - 1
                Case 3
                    CameraPositionX = CameraPositionX + 1
            End Select
            Player.movingx = 0
            Player.movingy = 0
        End If
    End If

End Sub


Sub MinMemFix 'this subroutine is specifically to try to fix a memory leak that occurs when in hardware accelerated mode, and the game is minimized. by simply turning off hardware acceleration.
    Static Last
    Select Case ScreenIcon
        Case -1
            If Last = -1 Then Exit Select
            SwitchRender 0
            Last = -1
        Case 0
            If Last = 0 Then Exit Select
            SwitchRender 1
            Last = 0

    End Select
End Sub

Function PickUpItem (ItemID)
    Static PickupDelay As Single
    If PickupDelay > CurrentTick Then
        PickUpItem = 1
        Exit Function
    End If
    If ItemID = -1 Then Exit Function
    Dim i, ii, iii
    For i = 0 To 3
        For ii = 0 To 5
            If Inventory(i, ii, 9) = ItemID Then
                Inventory(i, ii, 7) = Inventory(i, ii, 7) + 1
                If Inventory(i, ii, 7) > Inventory(i, ii, 8) Then Inventory(i, ii, 7) = Inventory(i, ii, 8): GoTo FullStack
                GoTo PickedUp
                FullStack:
            End If
        Next
    Next
    NewStack:
    For i = 0 To 3
        For ii = 0 To 5
            If Inventory(i, ii, 9) = -1 Then
                For iii = 0 To InvParameters
                    Inventory(i, ii, iii) = ItemIndex(ItemID, iii)
                Next
                GoTo PickedUp
            End If
        Next
    Next
    Alert 0, "Could not pick up item, Inventory full."
    PickUpItem = 1
    PickupDelay = CurrentTick + 60
    Exit Function
    PickedUp:
    PickUpItem = 0
End Function
Function FacingX
    Select Case Player.facing
        Case 0
            FacingX = Int((Player.x + 8) / 16) + 1

        Case 1
            FacingX = Int((Player.x + 8) / 16) + 1

        Case 2
            FacingX = Int((Player.x + 8 - 16) / 16) + 1

        Case 3
            FacingX = Int((Player.x + 8 + 16) / 16) + 1

    End Select

End Function

Function FacingY
    Select Case Player.facing
        Case 0

            FacingY = Int((Player.y + 8 - 16) / 16) + 1
        Case 1

            FacingY = Int((Player.y + 8 + 16) / 16) + 1
        Case 2

            FacingY = Int((Player.y + 8) / 16) + 1
        Case 3

            FacingY = Int((Player.y + 8) / 16) + 1
    End Select

End Function
Sub UseItem (Slot)
    Select Case Inventory(0, Slot, 0)
        Case 0 'Block placing
            Select Case Inventory(0, Slot, 4)
                Case 0
                    If GroundTile(FacingX, FacingY) = 0 Or GroundTile(FacingX, FacingY) = 13 Then
                        GroundTile(FacingX, FacingY) = Inventory(0, Slot, 3)
                        TileData(FacingX, FacingY, 4) = 255
                        If GameMode <> 1 Then
                            Inventory(0, Slot, 7) = Inventory(0, Slot, 7) - 1
                            If Inventory(0, Slot, 7) = 0 Then EmptySlot Slot, 0
                        End If
                        UpdateTile FacingX, FacingY
                        SpreadLight (1)
                    End If
                Case 1
                    If WallTile(FacingX, FacingY) = 1 And GroundTile(FacingX, FacingY) <> 0 And GroundTile(FacingX, FacingY) <> 13 Then
                        WallTile(FacingX, FacingY) = Inventory(0, Slot, 3)
                        If TileIndexData(WallTile(FacingX, FacingY), 7) = 1 Then
                            NewContainer SavedMapX, SavedMapY, FacingX, FacingY
                        End If
                        TileData(FacingX, FacingY, 5) = 255
                        If GameMode <> 1 Then
                            Inventory(0, Slot, 7) = Inventory(0, Slot, 7) - 1
                            If Inventory(0, Slot, 7) = 0 Then EmptySlot Slot, 0
                        End If
                        UpdateTile FacingX, FacingY
                        SpreadLight (1)
                    End If
            End Select
        Case 1 'Tools
            Select Case Inventory(0, Slot, 5)
                Case 0
                    If GroundTile(FacingX, FacingY) <> 0 Then
                        If TileData(FacingX, FacingY, 4) <= 0 Then
                            If GameMode <> 1 Then
                                If PickUpItem(TileIndex(GroundTile(FacingX, FacingY), 3)) = 1 Then Exit Select
                            End If
                            GroundTile(FacingX, FacingY) = 0
                            TileData(FacingX, FacingY, 4) = 255
                            UpdateTile FacingX, FacingY
                            SpreadLight (1)
                            Exit Select
                        End If
                        TileData(FacingX, FacingY, 4) = TileData(FacingX, FacingY, 4) - Inventory(0, Slot, 6)
                        TileData(FacingX, FacingY, 4) = TileData(FacingX, FacingY, 4) + TileIndexData(GroundTile(FacingX, FacingY), 4)
                        If TileData(FacingX, FacingY, 4) < 0 Then TileData(FacingX, FacingY, 4) = 0
                        If TileData(FacingX, FacingY, 4) > 255 Then TileData(FacingX, FacingY, 4) = 255
                    End If
                Case 1
                    If WallTile(FacingX, FacingY) <> 1 Then
                        If TileData(FacingX, FacingY, 5) <= 0 Then
                            If GameMode <> 1 Then
                                If PickUpItem(TileIndex(WallTile(FacingX, FacingY), 3)) = 1 Then Exit Select
                            End If
                            WallTile(FacingX, FacingY) = 1
                            TileData(FacingX, FacingY, 5) = 255
                            UpdateTile FacingX, FacingY
                            SpreadLight (1)
                            Exit Select
                        End If
                        TileData(FacingX, FacingY, 5) = TileData(FacingX, FacingY, 5) - Inventory(0, Slot, 6)
                        TileData(FacingX, FacingY, 5) = TileData(FacingX, FacingY, 5) + TileIndexData(WallTile(FacingX, FacingY), 4)
                        If TileData(FacingX, FacingY, 5) < 0 Then TileData(FacingX, FacingY, 5) = 0
                        If TileData(FacingX, FacingY, 5) > 255 Then TileData(FacingX, FacingY, 5) = 255
                    End If

            End Select

    End Select
    If TileData(FacingX, FacingY, 7) = 0 And GroundTile(FacingX, FacingY) = 0 Then
        WallTile(FacingX, FacingY) = 1
        UpdateTile FacingX, FacingY
        SpreadLight (1)

    End If
End Sub


Sub ChangeMap (Command, CommandMapX, CommandMapY)
    Static TickDelay
    Static TotalDelay
    Static LightStep
    Dim i, ii
    If LightStep < 12 Then
        Select Case Player.facing
            Case 0
                If Player.y <= 0 And Player.x = Player.lastx And Player.movingy = 1 Then TickDelay = TickDelay + Settings.TickRate: TotalDelay = TotalDelay + Settings.TickRate
            Case 1
                If Player.y >= 480 - 16 And Player.x = Player.lastx And Player.movingy = 1 Then TickDelay = TickDelay + Settings.TickRate: TotalDelay = TotalDelay + Settings.TickRate
            Case 2
                If Player.x <= 0 And Player.y = Player.lasty And Player.movingx = 1 Then TickDelay = TickDelay + Settings.TickRate: TotalDelay = TotalDelay + Settings.TickRate
            Case 3
                If Player.x >= 640 - 16 And Player.y = Player.lasty And Player.movingx = 1 Then TickDelay = TickDelay + Settings.TickRate: TotalDelay = TotalDelay + Settings.TickRate


        End Select
        If Command = 1 Then TickDelay = TickDelay + Settings.TickRate: TotalDelay = TotalDelay + Settings.TickRate
        If TickDelay = 5 Then TickDelay = 0: LightStep = LightStep + 2
        If Command = 1 Then ChangeMap 1, CommandMapX, CommandMapY
    Else
        SAVEMAP
        If Command = 0 Then
            Select Case Player.facing
                Case 0
                    SavedMapY = SavedMapY - 1
                    LOADMAP (SavedMap)
                    Player.y = 480
                Case 1
                    SavedMapY = SavedMapY + 1
                    LOADMAP (SavedMap)
                    Player.y = 0
                Case 2
                    SavedMapX = SavedMapX - 1
                    LOADMAP (SavedMap)
                    Player.x = 640
                Case 3
                    SavedMapX = SavedMapX + 1
                    LOADMAP (SavedMap)
                    Player.x = 0
            End Select
        End If
        If Command = 1 Then
            SavedMapX = CommandMapX
            SavedMapY = CommandMapY
            LOADMAP (SavedMap)
        End If
        For i = 0 To 31
            For ii = 0 To 41
                UpdateTile ii, i
            Next
        Next
        SpreadLight (1)

        LightStep = 0
    End If

    If Player.movingx = 0 And Player.movingy = 0 And Command = 0 Then TickDelay = 0: TotalDelay = 0: LightStep = 0
    OverlayLightLevel = LightStep

    'Print Player.x; Player.y; Player.lasty; Player.moving; Player.facing; TickDelay; Settings.TickRate
End Sub

Sub UpdateTile (TileX, TileY)
    Dim i, ii
    If TileIndexData(GroundTile(TileX, TileY), 0) = 1 Or TileIndexData(WallTile(TileX, TileY), 0) = 1 Then TileData(TileX, TileY, 0) = 1 Else TileData(TileX, TileY, 0) = 0
    If TileIndexData(GroundTile(TileX, TileY), 1) = 1 Or TileIndexData(WallTile(TileX, TileY), 1) = 1 Then TileData(TileX, TileY, 1) = 1 Else TileData(TileX, TileY, 1) = 0
    If TileIndexData(GroundTile(TileX, TileY), 2) = 1 Or TileIndexData(WallTile(TileX, TileY), 2) = 1 Then TileData(TileX, TileY, 2) = 1 Else TileData(TileX, TileY, 2) = 0
    If TileIndexData(GroundTile(TileX, TileY), 3) = 1 And TileIndexData(WallTile(TileX, TileY), 2) = 0 Then TileData(TileX, TileY, 3) = 1 Else TileData(TileX, TileY, 3) = 0
    '  TileData(TileX, TileY, 4) = TileIndexData(GroundTile(TileX, TileY), 4)
    '  TileData(TileX, TileY, 5) = TileIndexData(WallTile(TileX, TileY), 4)
    '  TileData(TileX, TileY, 6) = TileIndexData(CeilingTile(TileX, TileY), 4)
    TileData(TileX, TileY, 7) = TileIndexData(WallTile(TileX, TileY), 5)
    For i = 1 To 30
        For ii = 1 To 40
            TileData(TileX, TileY, 8) = 0
        Next
    Next

    If TileIndexData(GroundTile(TileX, TileY), 6) > TileData(TileX, TileY, 8) Then TileData(TileX, TileY, 8) = TileIndexData(GroundTile(TileX, TileY), 6)
    If TileIndexData(WallTile(TileX, TileY), 6) > TileData(TileX, TileY, 8) Then TileData(TileX, TileY, 8) = TileIndexData(WallTile(TileX, TileY), 6)
    If TileIndexData(CeilingTile(TileX, TileY), 6) > TileData(TileX, TileY, 8) Then TileData(TileX, TileY, 8) = TileIndexData(CeilingTile(TileX, TileY), 6)
    TileData(TileX, TileY, 9) = TileIndexData(GroundTile(TileX, TileY), 9)
    TileData(TileX, TileY, 10) = TileIndexData(GroundTile(TileX, TileY), 10)
End Sub
'For i = TileData(TileX, TileY, 8) To 0 Step -1

'Next

Sub Alert (img, message As String)
    Static timeout
    timeout = timeout + Settings.TickRate
    Locate 20, 1
    ENDPRINT message
    If timeout < 60 Then Alert img, message Else timeout = 0
End Sub

Sub INTER
    Select Case KeyPressed
        Case 15616
            Flag.DebugMode = Flag.DebugMode + 1
        Case 15104
            Flag.HudDisplay = Flag.HudDisplay + 1
        Case 101
            Flag.InventoryOpen = Flag.InventoryOpen + 1


    End Select
End Sub





Sub DEV
    If Flag.DebugMode = 1 Then
        PrintMode FillBackground
        Color , RGBA(0, 0, 0, 128)
        Dim comin As String
        Dim dv As Single
        Dim dummystring As String
        Dim databit As Byte
        Dim i, ii As Byte
        Dim DMapX, DMapY As Integer64
        Dim fillx, filly, fillid As Single

        Locate 1, 1
        ENDPRINT "Debug Menu (Press F3 to Close)"
        Print
        ENDPRINT "Version: " + Game.Buildinfo
        ENDPRINT "Version Designation: " + Game.Designation
        ENDPRINT "Operating System: " + Game.HostOS
        If RenderMode = 0 Then ENDPRINT "Render Mode: Software"
        If RenderMode = 1 Then ENDPRINT "Render Mode: Hardware Exclusive"
        If RenderMode = 2 Then ENDPRINT "Render Mode: Hardware"
        If Game.32Bit = 1 Then ENDPRINT "32-Bit Compatability Mode"
        Print
        ENDPRINT "Facing tile data:"
        If Player.x >= 0 And Player.x <= 640 - 16 And Player.y >= 0 And Player.y <= 480 - 16 Then

            For i = 0 To TileParameters
                dummystring = dummystring + Str$(TileData(FacingX, FacingY, i))
            Next
            ENDPRINT dummystring
            ENDPRINT Str$(GroundTile(FacingX, FacingY)) + Str$(WallTile(FacingX, FacingY)) + Str$(CeilingTile(FacingX, FacingY))
        End If
        Print
        ENDPRINT "Flags:"
        If Flag.StillCam = 1 Then ENDPRINT "Still Camera Enabled"
        If Flag.FreeCam = 1 Then ENDPRINT "Free Camera Enabled"
        If Flag.FullCam = 1 Then ENDPRINT "Full Camera Enabled"
        If Flag.NoClip = 1 Then ENDPRINT "No Clip Enabled"
        If bgdraw = 1 Then ENDPRINT "Background Drawing Disabled"
        If Flag.InventoryOpen = 1 Then ENDPRINT "Inventory Open"
        If Flag.CastShadows = 1 Then ENDPRINT "Shadows Disabled"


        Locate 1, 1
        Print Game.Title; " ("; Game.Version; ")"
        Print
        Print "FPS:" + Str$(OGLFPS) + " / TPS:" + Str$(FRAMEPS) + " / Tick:" + Str$(CurrentTick)
        Print "Window:"; CameraPositionX; ","; CameraPositionY
        Print "Current World: "; WorldName; " (" + SavedMap + ")"
        Print "World Seed:"; WorldSeed
        Print "Map Seed:"; Val(Str$(SavedMapX)) + Val(Str$(SavedMapY)) + Val(Str$(WorldSeed))
        Print "Current Time:"; GameTime + (TimeMode * 43200)
        Print "Light Level: (G:"; GlobalLightLevel; ", L:"; LocalLightLevel((Player.x + 8) / 16, (Player.y + 8) / 16); ", O:"; OverlayLightLevel; ")"

        Print "Gamemode: ";
        Select Case GameMode
            Case 0
                Print "Legacy Map Editor"
            Case 1
                Print "Creative"
            Case 2
                Print "Survival"
            Case 3
                Print "Combat"
            Case 4
                Print "Hub"
        End Select

        Print
        Print "Data Viewer: ";
        Select Case Debug.Tracking
            Case ""
                Print "None Selected"
                Print "Start tracking an entity to view its data"
            Case "player", "1"
                Print "Player"
                Print "POS:"; Player.x; ","; Player.y; "("; Int((Player.x + 8) / 16) + 1; ","; Int((Player.y + 8) / 16) + 1; ")"
                Print "GlobalPOS"; "("; Int((Player.x + 8) / 16) + 1 + (SavedMapX * 40); ","; Int((Player.y + 8) / 16) + 1 + (SavedMapY * 30); ")"
                Print "Velocity:"; Player.vx; Player.vy
                Print "Facing:"; Player.facing
                Print "Motion:"; Player.movingx; Player.movingy
                Print Player.lastx; Player.lasty
            Case "inv", "inventory", "2"
                Print "Inventory Data"
                If CursorHoverPage = 1 Then
                    Select Case Inventory(CursorHoverY, CursorHoverX, 0)
                        Case 0
                            Print "Tile: "; Trim$((ItemName(Inventory(CursorHoverY, CursorHoverX, 9), 0))); " | SS:"; Str$(Inventory(CursorHoverY, CursorHoverX, 1)); ","; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 2))); " | TileID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 3)); " | Layer:"; Str$(Inventory(CursorHoverY, CursorHoverX, 4)); " | "; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 5))) + Str$(Inventory(CursorHoverY, CursorHoverX, 6)); " | Stack:"; Str$(Inventory(CursorHoverY, CursorHoverX, 7)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 8))); " | ID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 9)); ""
                        Case 1
                            Print "Tool: "; Trim$(ItemName(Inventory(CursorHoverY, CursorHoverX, 9), 0)); " | SS:"; Str$(Inventory(CursorHoverY, CursorHoverX, 1)); ","; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 2))); " | Durabillity:"; Str$(Inventory(CursorHoverY, CursorHoverX, 3)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 4))); " | Type:"; Str$(Inventory(CursorHoverY, CursorHoverX, 5)); " | Strength:"; Str$(Inventory(CursorHoverY, CursorHoverX, 6)); " | Stack:"; Str$(Inventory(CursorHoverY, CursorHoverX, 7)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 8))); " | ID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 9)); ""
                        Case 2
                            Print "Sword: "; Trim$(ItemName(Inventory(CursorHoverY, CursorHoverX, 9), 0)); " | SS:"; Str$(Inventory(CursorHoverY, CursorHoverX, 1)); ","; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 2))); " | Durabillity:"; Str$(Inventory(CursorHoverY, CursorHoverX, 3)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 4))); " | Delay:"; Str$(Inventory(CursorHoverY, CursorHoverX, 5)); " | Damage:"; Str$(Inventory(CursorHoverY, CursorHoverX, 6)); " | Stack:"; Str$(Inventory(CursorHoverY, CursorHoverX, 7)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 8))); " | ID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 9)); " | Range"; Str$(Inventory(CursorHoverY, CursorHoverX, 10)); " | Speed:"; Str$(Inventory(CursorHoverY, CursorHoverX, 11));
                        Case 3
                            Print "Crafting Ingredient: "; Trim$(ItemName(Inventory(CursorHoverY, CursorHoverX, 9), 0)); " | SS:"; Str$(Inventory(CursorHoverY, CursorHoverX, 1)); ","; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 2))); " |"; Str$(Inventory(CursorHoverY, CursorHoverX, 3)) + Str$(Inventory(CursorHoverY, CursorHoverX, 4)) + Str$(Inventory(CursorHoverY, CursorHoverX, 5)) + Str$(Inventory(CursorHoverY, CursorHoverX, 6)); " | Stack:"; Str$(Inventory(CursorHoverY, CursorHoverX, 7)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 8))); " | ID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 9)); ""
                        Case Else
                            Print "Unknown";
                            If Inventory(CursorHoverY, CursorHoverX, 9) > -1 Then Print ": "; Trim$(ItemName(Inventory(CursorHoverY, CursorHoverX, 9), 0));
                            Print ; " | SS:"; Str$(Inventory(CursorHoverY, CursorHoverX, 1)); ","; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 2))); " |"; Str$(Inventory(CursorHoverY, CursorHoverX, 3)) + Str$(Inventory(CursorHoverY, CursorHoverX, 4)) + Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 5))) + Str$(Inventory(CursorHoverY, CursorHoverX, 6)); " | Stack:"; Str$(Inventory(CursorHoverY, CursorHoverX, 7)); "/"; Trim$(Str$(Inventory(CursorHoverY, CursorHoverX, 8))); " | ID:"; Str$(Inventory(CursorHoverY, CursorHoverX, 9)); ""
                    End Select
                End If
                'For i = 0 To InvParameters
                '    Print Inventory(0, 0, i);
                'Next
            Case Else
                Print "Unrecognized Tile or Entity"
        End Select

        If KeyDown(47) Then
            Flag.OpenCommand = 1
            If Flag.RenderOverride = 0 Then SwitchRender (0)
        End If

        If Flag.OpenCommand = 2 Then
            KeyClear
            Locate 28, 1: Input "/", comin
            Select Case comin
                Case "teleport", "tp"
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport x: ", Player.x
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport y: ", Player.y
                Case "tileport", "tip"
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport x: ", dv
                    Player.x = dv * 16
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport y: ", dv
                    Player.y = dv * 16
                Case "craft"
                    Dim testx, testy, testitem
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport x: ", testx
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport x: ", testy
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Teleport x: ", testitem

                    For i = 0 To InvParameters
                        CraftingGrid(testx, testy, i) = ItemIndex(testitem, i)
                    Next

                Case "res", "resolution"
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Resolution X: ", ScreenRezX
                    Locate 28, 1: Print "               "
                    Locate 28, 1: Input "Resolution Y: ", ScreenRezY
                    Screen NewImage(ScreenRezX + 1, ScreenRezY + 1, 32)



                Case "stillcam", "sc"
                    Flag.StillCam = Flag.StillCam + 1
                Case "fullcam", "fc"
                    Flag.FullCam = Flag.FullCam + 1
                Case "freecam", "frc"
                    Flag.FreeCam = Flag.FreeCam + 1
                Case "noclip", "nc"
                    Flag.NoClip = Flag.NoClip + 1
                Case "exit"
                    System
                Case "error"
                    Locate 28, 1: Input "Simulate error number: ", dv
                    Error dv
                Case "gamemode", "gm"
                    Locate 28, 1: Input "Change Gamemode to: ", GameMode
                Case "health"
                    Locate 28, 1: Input "Set Health to: ", Player.health
                Case "track", "tr"
                    Locate 28, 1: Print "                               "
                    Locate 28, 1: Input "Track Entity ID or Tile ID: ", Debug.Tracking
                Case "framerate-unlock", "fru"
                    Flag.FrameRateLock = Flag.FrameRateLock + 1
                Case "save"
                    SAVEMAP
                    SAVESETTINGS
                Case "load"
                    Locate 28, 1: Print "                                "
                    Locate 28, 1: Input "Name of Map File to load: ", map.filename
                    LOADMAP (map.filename)
                Case "loadworld"
                    Locate 28, 1: Print "                                "
                    Locate 28, 1: Input "Name of World Folder to load: ", WorldName
                    LOADWORLD
                Case "groundtile", "gt"
                    Locate 28, 1: Print "                   "
                    Locate 28, 1: Input "Set GroundTile ID: ", GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1)
                Case "walltile", "wt"
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "Set WallTile ID: ", WallTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1)
                Case "ceilingtile", "ct"
                    Locate 28, 1: Print "                   "
                    Locate 28, 1: Input "Set CeilingTile ID: ", CeilingTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1)
                Case "fillwalltile", "fillwt", "fwt"
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "WallTile ID: ", fillid
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "X  from pos: ", fillx
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "Y  from pos: ", filly

                    For i = 0 To fillx Step Sgn(fillx)
                        For ii = 0 To filly Step Sgn(filly)
                            WallTile(Int((Player.x + 8) / 16) + 1 + i, Int((Player.y + 8) / 16) + 1 + ii) = fillid
                        Next
                    Next

                Case "fillgroundtile", "fillgt", "fgt"
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "GroundTile ID: ", fillid
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "X  from pos: ", fillx
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "Y  from pos: ", filly

                    For i = 0 To fillx Step Sgn(fillx)
                        For ii = 0 To filly Step Sgn(filly)
                            GroundTile(Int((Player.x + 8) / 16) + 1 + i, Int((Player.y + 8) / 16) + 1 + ii) = fillid
                        Next
                    Next
                Case "fillceilingtile", "fillct", "fct"
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "WallTile ID: ", fillid
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "X  from pos: ", fillx
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "Y  from pos: ", filly

                    For i = 0 To fillx Step Sgn(fillx)
                        For ii = 0 To filly Step Sgn(filly)
                            CeilingTile(Int((Player.x + 8) / 16) + 1 + i, Int((Player.y + 8) / 16) + 1 + ii) = fillid
                        Next
                    Next

                Case "tiledata", "td"
                    Locate 28, 1: Print "                 "
                    Locate 28, 1: Input "Select Data Bit: ", databit
                    Locate 28, 1: Print "                   "
                    Locate 28, 1: Input "Select Data Value: ", TileData(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1, databit)


                Case "bgdraw"
                    bgdraw = bgdraw + 1
                Case "shadowcast", "sh"
                    Flag.CastShadows = Flag.CastShadows + 1

                Case "new"
                    NewWorld

                Case "lightlevel", "ll"
                    Locate 28, 1: Print "                    "
                    Locate 28, 1: Input "Select Light Level:  ", GlobalLightLevel
                Case "rendermode", "rm"
                    Locate 28, 1: Print "         "
                    Locate 28, 1: Input "Mode:  ", RenderMode
                    If RenderMode = 2 Then Flag.RenderOverride = 0
                    If RenderMode = 0 Then Flag.RenderOverride = 1: SwitchRender (0)
                    If RenderMode = 1 Then Flag.RenderOverride = 1: SwitchRender (1)
                Case "updatemap", "um"
                    For i = 0 To 31
                        For ii = 0 To 41
                            UpdateTile ii, i
                        Next
                    Next
                    SpreadLight (1)
                Case "tickrate", "tk"
                    Locate 28, 1: Print "          "
                    Locate 28, 1: Input "TickRate:  ", Settings.TickRate
                Case "time"
                    Locate 28, 1: Print "          "
                    Locate 28, 1: Input "Set time:  ", GameTime
                Case "maptp"
                    Locate 28, 1: Print "              "
                    Locate 28, 1: Input "MapX Cord", DMapX
                    Locate 28, 1: Print "              "
                    Locate 28, 1: Input "MapY Cord", DMapY
                    ChangeMap 1, DMapX, DMapY
                Case "genmap"
                    GenerateMap
                Case Else
            End Select
            KeyClear
            Flag.ScreenRefreshSkip = 1
            Flag.OpenCommand = 0
            If Flag.RenderOverride = 0 Then SwitchRender (1)
        End If
        Color , RGBA(0, 0, 0, 0)
        PrintMode KeepBackground
    End If
End Sub





Sub INITIALIZE
    Dim As Byte i, ii, iii
    ScreenRezX = DesktopWidth
    ScreenRezY = DesktopHeight
    Screen NewImage(ScreenRezX + 1, ScreenRezY + 1, 32)
    FullScreen SquarePixels

    If DirExists("Assets") Then
        If DirExists("Assets\Sprites") = 0 Then Error 100
        If DirExists("Assets\Sprites\Entities") = 0 Then Error 100
        If DirExists("Assets\Sprites\Items") = 0 Then Error 100
        If DirExists("Assets\Sprites\Other") = 0 Then Error 100
        If DirExists("Assets\Sprites\Tiles") = 0 Then Error 100
        If DirExists("Assets\Music") = 0 Then Error 100
        If DirExists("Assets\Sounds") = 0 Then Error 100
        If DirExists("Assets\Worlds") = 0 Then MkDir "Assets\Worlds"
        If DirExists("Assets\SaveData") = 0 Then MkDir "Assets\SaveData": new = 1
    Else Error 100
    End If

    For i = 0 To MaxCraftLevel
        For ii = 0 To MaxCraftLevel
            For iii = 0 To InvParameters
                CraftingGrid(ii, i, iii) = -1
            Next
        Next
    Next

    If new = 1 Then SAVESETTINGS
    LOADSETTINGS
    Screen NewImage(ScreenRezX + 1, ScreenRezY + 1, 32)
    If Settings.FullScreen = 1 Then FullScreen SquarePixels
    If Settings.FullScreen = 0 Then FullScreen Off

    OSPROBE

    SwitchRender (DefaultRenderMode)
    RenderMode = DefaultRenderMode


End Sub



'$include: 'Assets\Sources\InventoryManagement.bm'
'$include: 'Assets\Sources\ShadowCast.bm'
'$include: 'Assets\Sources\DayNightCycle.bm'
'$include: 'Assets\Sources\Initialization.bm'
'$include: 'Assets\Sources\FileAccess.bm'
'$include: 'Assets\Sources\TextControl.bm'
'$include: 'Assets\Sources\ErrorHandler.bm'
'$include: 'Assets\Sources\FrameRate.bm'
'$include: 'Assets\Sources\OsProbe.bm'
'$include: 'Assets\Sources\CollisionDetection.bm'
'$include: 'Assets\Sources\SpriteAnimation.bm'
'$include: 'Assets\Sources\PlayerControl.bm'
'$include: 'Assets\Sources\MapDraw.bm'
'$include: 'Assets\Sources\ScreenZoom.bm'
'$include: 'Assets\Sources\AudioControl.bm'
'$include: 'Assets\Sources\PerlinNoise.bm'
'$include: 'Assets\Sources\EffectFunctions.bm'
'$include: 'Assets\Sources\WorldGeneration.bm'
'$include: 'Assets\Sources\LegacyHUD.bm'
Sub PlaySound (nam$)
    _SndPlayFile nam$, , 1
End Sub

 


Sub COLDET
    Dim ColU, ColD, ColL, ColR
    Dim StuckFix As _Byte 'why???, $option noprefix is enabled why the fuck does this have an underscore, also where is this used?
    Dim i
    Player.tile = GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1)
    Select Case Player.facing
        Case 0
            If Player.y - 8 <= 0 Then Exit Select
            Player.tilefacing = GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 - 16) / 16) + 1)
        Case 1
            If Player.y + 8 + 16 >= 480 Then Exit Select
            Player.tilefacing = GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8 + 16) / 16) + 1)
        Case 2
            If Player.x - 8 <= 0 Then Exit Select
            Player.tilefacing = GroundTile(Int((Player.x + 8 - 16) / 16) + 1, Int((Player.y + 8) / 16) + 1)
        Case 3
            If Player.x + 8 + 16 >= 640 Then Exit Select
            Player.tilefacing = GroundTile(Int((Player.x + 8 + 16) / 16) + 1, Int((Player.y + 8) / 16) + 1)
    End Select

    If Flag.NoClip = 0 Then
        Select Case TileData(Int((Player.x + 1) / 16) + 1, Int((Player.y + 1) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty

                ColU = 1
                GoTo col2

        End Select

        Select Case TileData(Int((Player.x + 1) / 16) + 1, Int((Player.y + 14) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty

                ColD = 1
        End Select

        Select Case TileData(Int((Player.x + 14) / 16) + 1, Int((Player.y + 1) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty

                ColU = 1
                GoTo col2

        End Select

        Select Case TileData(Int((Player.x + 14) / 16) + 1, Int((Player.y + 14) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty

                ColD = 1
        End Select

        col2:

        Select Case TileData(Int((Player.x + 1) / 16) + 1, Int((Player.y + 1) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty
                Player.x = Player.lastx
                ' Print " Colision Left"
                ColU = 0
                ColD = 0
                ColL = 1
        End Select

        Select Case TileData(Int((Player.x + 14) / 16) + 1, Int((Player.y + 1) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty
                Player.x = Player.lastx
                ' Print " Colision Right"
                ColU = 0
                ColD = 0
                ColR = 1
        End Select

        Select Case TileData(Int((Player.x + 1) / 16) + 1, Int((Player.y + 14) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty
                Player.x = Player.lastx
                '  Print " Colision Left"
                ColU = 0
                ColD = 0

                ColL = 1
        End Select

        Select Case TileData(Int((Player.x + 14) / 16) + 1, Int((Player.y + 14) / 16) + 1, 0)
            Case 1
                Swap Player.y, Player.lasty
                Player.x = Player.lastx
                ' Print " Colision Right"
                ColU = 0
                ColD = 0

                ColR = 1
        End Select
    End If

    'push player outside of tile if inside

    If Flag.NoClip = 0 Then
        Select Case TileData(Int((Player.x + 7) / 16) + 1, Int((Player.y + 1) / 16) + 1, 0)
            Case 1
                Player.y = Player.y + 1
                '  Print " Colision 3,1"
        End Select

        Select Case TileData(Int((Player.x + 7) / 16) + 1, Int((Player.y + 14) / 16) + 1, 0)
            Case 1
                ' Swap Player.y, Player.lasty
                Player.y = Player.y - 1
                '  Print " Colision 3,2"
        End Select

        Select Case TileData(Int((Player.x + 1) / 16) + 1, Int((Player.y + 7) / 16) + 1, 0)
            Case 1

                Player.x = Player.x + 1
                ' Print " Colision 3,3"
        End Select

        Select Case TileData(Int((Player.x + 14) / 16) + 1, Int((Player.y + 7) / 16) + 1, 0)
            Case 1
                Player.x = Player.x - 1
                ' Print " Colision 3,4"
        End Select
    End If

    If ColU = 1 Or ColD = 1 Then Player.vy = 0
    If ColL = 1 Or ColR = 1 Then Player.vx = 0

    If ColU = 1 Then ContactEffect (1): 'Print "COLISION"
    If ColD = 1 Then ContactEffect (2): 'Print "COLISION"
    If ColL = 1 Then ContactEffect (3): 'Print "COLISION"
    If ColR = 1 Then ContactEffect (4): 'Print "COLISION"


End Sub


Dim i
For i = 0 To invparameters
    CreativeInventory(0, 0, i, 0) = ItemIndex(0, i)
    CreativeInventory(0, 1, i, 0) = ItemIndex(1, i)
    CreativeInventory(0, 2, i, 0) = ItemIndex(2, i)
    CreativeInventory(0, 3, i, 0) = ItemIndex(3, i)
    CreativeInventory(0, 4, i, 0) = ItemIndex(4, i)
    CreativeInventory(0, 5, i, 0) = ItemIndex(5, i)
    CreativeInventory(1, 0, i, 0) = ItemIndex(6, i)
    CreativeInventory(1, 1, i, 0) = ItemIndex(7, i)
    CreativeInventory(1, 2, i, 0) = ItemIndex(8, i)
    CreativeInventory(1, 3, i, 0) = ItemIndex(9, i)
    CreativeInventory(1, 4, i, 0) = ItemIndex(10, i)
    CreativeInventory(1, 5, i, 0) = ItemIndex(11, i)
    CreativeInventory(2, 0, i, 0) = ItemIndex(12, i)
    CreativeInventory(2, 1, i, 0) = ItemIndex(15, i)
    CreativeInventory(2, 2, i, 0) = ItemIndex(16, i)
    CreativeInventory(2, 3, i, 0) = ItemIndex(17, i)
    CreativeInventory(2, 4, i, 0) = ItemIndex(18, i)
    CreativeInventory(2, 5, i, 0) = ItemIndex(19, i)
Next

 
Sub DayLightCycle
    '86400
    GameTime = GameTime + Settings.TickRate
    If GameTime > 43200 Then GameTime = GameTime - 43200: TimeMode = TimeMode + 1
    If TimeMode > 1 Then TimeMode = 0

    Select Case TimeMode
        Case 0
            GlobalLightLevel = 12
            If GameTime > 38200 Then
                GlobalLightLevel = 12 - (((GameTime - 38200) / 1000)) * 2
            End If
        Case 1
            GlobalLightLevel = 2
            If GameTime > 38200 Then
                GlobalLightLevel = 2 + (((GameTime - 38200) / 1000)) * 2
            End If
    End Select
End Sub
 
'Note: any changes made to this file, and any other source files require a recompile of the game before they are recognized

'Default variables that are required to be set on initial load
Game.Title = "TerraQuest"
Game.Buildinfo = "Alpha Version 22.0 Edge 6
Game.Version = "A22.0-E6
Game.Designation = "Edge"
Game.FCV = 1

'Default settings values that are saved on first launch to settings.cdf, and on subsequent launches are loaded from that file
Settings.FrameRate = 60
Settings.TickRate = 1

'File name locations
File.PlayerSprites = "Assets\Sprites\Entities\character.png"
File.TileSheet = "Assets\Sprites\Tiles\Tiles.png"
File.ItemSheet = "Assets\Sprites\Items\Items.png
File.HudSprites = "Assets\Sprites\Other\HUD.png"
File.Shadows = "Assets\Sprites\Other\Shadows.png"

Sounds.error = "Assets\Sounds\error.wav"
Sounds.walk_grass= "Assets\Sounds\walk_grass.mp3"
Sounds.damage_bush= "Assets\Sounds\damage_bush.mp3"
Sounds.walk_water= "Assets\Sounds\walk_water.mp3"

'Debug values that are only set here for testing purposes
Player.health = 8
GameMode = 2
Flag.DebugMode =1
Flag.NoClip = 0
GlobalLightLevel = 12
flag.renderoverride=0
defaultrendermode=2
      Dim ii, iii, iiii
For ii = 0 To 3
    For iii = 0 To 5
        For iiii = 0 To 9
            Inventory(ii, iii, iiii) = -1
        Next
    Next
Next






Sub ErrorHandler
    AutoDisplay
    Cls
    PLAYSOUND Sounds.error
    Delay 0.5
    KeyClear
    Locate 1, 1
    CENTERPRINT "CDF ERROR HANDLER"
    Print "Error Code:"; Err
    Locate 2, 1
    ENDPRINT "Error Line:" + Str$(ErrorLine)
    Print "--------------------------------------------------------------------------------"
    Print
    '       PRINT "--------------------------------------------------------------------------------"
    Select Case Err
        Case 100
            Print "Assets folder is incomplete, this error can be triggered by one or more of the"
            Print "following conditions:"
            Print
            Print
            Print "     The assets folder is missing"
            Print
            Print "     Sub-directories in the Assets folder are missing"
            Print
            Print "     The contents of assets, or the directory itself is corrupted"
            Print
            Print "     You do not have proper permissions to access the assets directory"
            Print
            Print
            Print "Make sure the entireity of the assets folder is present and accessible to your"
            Print "user account and, if necessary, redownload the assets folder."
            Print
            Print "The assets folder, and its contents are necessary for the game to load, as it"
            Print "contains all sprite and texture files, sounds and music, user saved data, and"
            Print "world files. Without these, the game will not play correctly. It is advised to"
            Print "not continue."
            CONTPROMPT

        Case 101
            Print "This is a legacy error code, and should never be triggered in game, if it has"
            Print "been triggered, not due to the /error command, please contact the developer"
            CONTPROMPT

        Case 102
            Print "Invalid Code Position, This error occurs when the program flow enters an area"
            Print "that it should not be, This is most likely a programming issue, and not an end"
            Print "user issue."
            Print ""
            Print "There is no user solution to this issue, if this is reproducable, please file
            print "a bug report to the github, including the line number and what you were doing
            print "when it occured."
            CONTPROMPT
            Case 258
            ?"Invalid handle, An handle used for an image, sound, font etc. was invalid.
            ?"Be sure to check the return values of functions like _LOADFONT and _LOADIMAGE.

        Case 103
            Print "This world was not made for this version of "; Game.Title; ". This means one of"
            Print "the following cases is true:"
            Print
            Print
            Print "     You are attempting to load an out of date world"
            Print
            Print "     You are attempting to load a world designed for a newer version of"
            Print "     "; Game.Title
            Print
            Print "     Your world manifest is corrupted"
            Print
            Print
            Print "Double check the world version and game version."
            Print "World: ("; mapversion; ") Game: ("; Game.Version; ")"
            Print
            Print "If you are certain that this is a mistake, you may try to update the manifest"
            Print "here. Note that this does not update old worlds, just broken manifest files"
            Print "Otherwise you can try to load a different world. "; Game.Title; ""
            Print "does not support loading out of version worlds."
            Print
            Print
            CENTERPRINT "(U)pdate manifest, (R)eturn to existing map, (Q)uit to desktop."
            Do
                If KeyDown(113) Then System
                If KeyDown(114) Then Exit Do
                If KeyDown(117) Then
                    Open "Assets\Worlds\" + WorldName + "\Manifest.cdf" As #1
                    Put #1, 3, Game.Version
                    Close #1

                    Exit Do

                End If
            Loop
        Case 2
            Print "Syntax error, READ attempted to read a number but could not parse the next"
            Print "DATA item."
            Print
            CONTPROMPT
        Case 3
            Print "RETURN without GOSUB, The RETURN statement was encounted without first"
            Print " executing a corresponding GOSUB."
            Print
            CONTPROMPT
        Case 4
            Print "Out of DATA, The READ statement has read past the end of a DATA block."
            Print " Use RESTORE to change the current data item if necessary."
            Print
            CONTPROMPT

        Case 9
            Print "Subscript out of range, this error occurs when an array exceeds its bounds"
            Print "This is most likely a programming error, please let the developer know."
            Print
            CONTPROMPT


        Case Else
            Print "Unrecognized error, contact developers"
            CONTPROMPT

    End Select

    KeyClear
    Cls
    Resume Next
End Sub

Sub CONTPROMPT
    Print
    Print

    CENTERPRINT "(I)gnore this error and continue anyway, (Q)uit to desktop"
    Do
        If KeyDown(113) Then System
        If KeyDown(105) Then Exit Do
    Loop
End Sub



Sub SAVESETTINGS
                          dim as byte zero,one
                          zero=0
                          one=1

    Open "Assets\SaveData\Settings.cdf" As #1
    Put #1, 1, Settings.FrameRate
    Put #1, 2, Settings.TickRate
    Put #1, 3, Screenrezx
    Put #1, 4, Screenrezy
    If fullscreen = 0 Then Put #1, 5, zero
    If fullscreen = 2 Then Put #1, 5, one
    Close #1

End Sub




Sub LOADSETTINGS

    Open "Assets\SaveData\Settings.cdf" As #1
    Get #1, 1, Settings.FrameRate
    Get #1, 2, Settings.TickRate
    Get #1, 3, Screenrezx
    Get #1, 4, Screenrezy
    get #1,5,settings.fullscreen

    Close #1

End Sub

Function SavedMap$
    SavedMap = Str$(SavedMapX) + Str$(SavedMapY)
End Function

Function SpawnMap$
    SpawnMap = Str$(SpawnMapX) + Str$(SpawnMapY)
End Function

Sub LOADWORLD
    Dim defaultmap As String
    Dim As Byte i, ii
    Dim As Integer iii
    Dim total
    prevfolder = map.foldername


    Open "Assets\Worlds\" + WorldName + "\Manifest.cdf" As #1

    Get #1, 1, GameTime

    Get #1, 3, mapversion
    If mapversion <> Game.Version Then
        Close #1
        Error 103
    End If

    Get #1, 5, SpawnPointX
    Get #1, 6, SpawnPointY
    Get #1, 7, SavePointX
    Get #1, 8, SavePointY
    Get #1, 9, SavedMapX
    Get #1, 10, SavedMapY
    Get #1, 11, SpawnMapX
    Get #1, 12, SpawnMapY
    get #1,13,worldseed
    Close #1
    Open "Assets\Worlds\" + WorldName + "\Player.cdf" As #1
    total = 1
    i = 0
    ii = 0
    iii = 0

    While i < 4
        Get #1, total, Inventory(i, ii, iii)
        iii = iii + 1
        If iii > invparameters Then iii = 0: ii = ii + 1
        If ii > 5 Then ii = 0: i = i + 1
        total = total + 1
    Wend
    Get #1, total, GameMode: total = total + 1
    Get #1, total, Player.facing: total = total + 1
    Get #1, total, Player.level: total = total + 1
    Get #1, total, Player.health: total = total + 1
    Get #1, total, Player.points: total = total + 1
    Get #1, total, Player.experience: total = total + 1
    Get #1, total, Player.gold: total = total + 1
    Close #1

    Player.x = SavePointX
    Player.y = SavePointY

    'GET #1, 4, map.protected

    LOADMAP (SavedMap)
End Sub


Sub LOADMAP (file As String)
    Dim i, ii As Byte
    Dim iii As Integer
    Dim iiii As Byte

    iii = 1


    'TODO make this a sub with 2 parameterss, 1
    If FileExists("Assets\Worlds\" + WorldName + "\Maps\" + file + ".cdf") Then
        Open "Assets\Worlds\" + WorldName + "\Maps\" + file + "-0.cdf" As #1
        For i = 1 To 30
            For ii = 1 To 40
                Get #1, iii, GroundTile(ii, i)
                iii = iii + 1
            Next
        Next
        Close #1
        iii = 1

        Open "Assets\Worlds\" + WorldName + "\Maps\" + file + "-1.cdf" As #1
        For i = 1 To 30
            For ii = 1 To 40
                Get #1, iii, WallTile(ii, i)
                iii = iii + 1
            Next
        Next
        Close #1
        iii = 1


        Open "Assets\Worlds\" + WorldName + "\Maps\" + file + "-2.cdf" As #1
        For i = 1 To 30
            For ii = 1 To 40
                Get #1, iii, CeilingTile(ii, i)
                iii = iii + 1
            Next
        Next
        Close #1
        iii = 1


        Open "Assets\Worlds\" + WorldName + "\Maps\" + file + "-3.cdf" As #1
        For i = 1 To 30
            For ii = 1 To 40
                For iiii = 0 To tileparameters
                    Get #1, iii, TileData(ii, i, iiii)
                    iii = iii + 1
                Next

            Next
        Next
        Get #1, iii, map.name
        Close #1
        iii = 1

    Else
        GenerateMap
        SAVEMAP
    End If

End Sub




Sub SAVEMAP
    Dim i, ii, iiii As Byte
    Dim iii As Integer
    Dim defaultmap As String
    Dim temppw As String
    Dim new As Byte
    Dim total
    iii = 1
    'update this
    If DirExists("Assets\Worlds\" + WorldName) = 0 Then
        MkDir "Assets\Worlds\" + WorldName: new = 1
        MkDir "Assets\Worlds\" + WorldName + "\Maps"
                MkDir "Assets\Worlds\" + WorldName + "\Containers"
    End If


    Open "Assets\Worlds\" + WorldName + "\Manifest.cdf" As #1
    If new = 0 Then
    End If


    SavePointX = Player.x
    SavePointY = Player.y
    If TimeMode = 1 Then GameTime = GameTime + 43200
    Put #1, 1, GameTime

    Put #1, 3, Game.Version

    Put #1, 5, SpawnPointX
    Put #1, 6, SpawnPointY
    Put #1, 7, SavePointX
    Put #1, 8, SavePointY
    Put #1, 9, SavedMapX
    Put #1, 10, SavedMapY
    Put #1, 11, SpawnMapX
    Put #1, 12, SpawnMapY
        put #1,13,worldseed
    Close #1
    Open "Assets\Worlds\" + WorldName + "\Player.cdf" As #1
    total = 1
    i = 0
    ii = 0
    iii = 0

    While i < 4
        Put #1, total, Inventory(i, ii, iii)
        iii = iii + 1
        If iii > invparameters Then iii = 0: ii = ii + 1
        If ii > 5 Then ii = 0: i = i + 1
        total = total + 1
    Wend
    If TimeMode = 1 Then GameTime = GameTime - 43200
    Put #1, total, GameMode: total = total + 1
    Put #1, total, Player.facing: total = total + 1
    Put #1, total, Player.level: total = total + 1
    Put #1, total, Player.health: total = total + 1
    Put #1, total, Player.points: total = total + 1
    Put #1, total, Player.experience: total = total + 1
    Put #1, total, Player.gold: total = total + 1

    Close #1
    iii = 1
    Open "Assets\Worlds\" + WorldName + "\Maps\" + SavedMap + "-0.cdf" As #1
    For i = 1 To 30
        For ii = 1 To 40
            Put #1, iii, GroundTile(ii, i)
            iii = iii + 1
        Next
    Next
    Close #1
    iii = 1

    Open "Assets\Worlds\" + WorldName + "\Maps\" + SavedMap + "-1.cdf" As #1
    For i = 1 To 30
        For ii = 1 To 40
            Put #1, iii, WallTile(ii, i)
            iii = iii + 1
        Next
    Next
    Close #1
    iii = 1


    Open "Assets\Worlds\" + WorldName + "\Maps\" + SavedMap + "-2.cdf" As #1
    For i = 1 To 30
        For ii = 1 To 40
            Put #1, iii, CeilingTile(ii, i)
            iii = iii + 1
        Next
    Next
    Close #1
    iii = 1


    Open "Assets\Worlds\" + WorldName + "\Maps\" + SavedMap + "-3.cdf" As #1
    For i = 1 To 30
        For ii = 1 To 40
            For iiii = 0 To tileparameters
                Put #1, iii, TileData(ii, i, iiii)
                iii = iii + 1
            Next
        Next
    Next
    Put #1, iii, map.name
    Close #1
    iii = 1

    Open "Assets\Worlds\" + WorldName + "\Maps\" + SavedMap + ".cdf" As #1: Close #1





    badpw:
End Sub




Function FRAMEPS
    Static ps As Byte
    Static cs As Byte
    Static frame As Integer
    Static frps As Integer
    ps = cs
    cs = Val(Mid$(Time$, 7, 2))
    If cs = ps Then frame = frame + 1 Else frps = frame: frame = 0
    FRAMEPS = frps + 1
End Function


Sub _GL
    'If Flag.RenderOverride <> 0 Then Exit Sub
    OpenGLFPS
End Sub
Sub OpenGLFPS
    Static ps As Byte
    Static cs As Byte
    Static frame As Integer
    Static frps As Integer

    ps = cs
    cs = Val(Mid$(Time$, 7, 2))
    If cs = ps Then frame = frame + 1 Else frps = frame: frame = 0
    OGLFPS = frps + 1
End Sub


Dim Shared ItemIndex(1000, InvParameters)
Dim Shared ItemName(1000, 2) As String

ItemName(0, 0) = "Creative Shovel"
ItemName(0, 1) = "Allows you to break ground tiles"
ItemIndex(0, 0) = 1 'item type (1 means tool)
ItemIndex(0, 1) = 16 'item texture x cord
ItemIndex(0, 2) = 0 'item texture y cord
ItemIndex(0, 3) = 0 'tool max durabillity
ItemIndex(0, 4) = 1 'tool current durrabillity
ItemIndex(0, 5) = 0 'tool type
ItemIndex(0, 6) = 1000 'tool strength
ItemIndex(0, 7) = 1 'current stack
ItemIndex(0, 8) = 1 'max stack
ItemIndex(0, 9) = 0 'Item ID

ItemName(1, 0) = "Creative Axe"
ItemName(1, 1) = "Allows you to break wall tiles"
ItemIndex(1, 0) = 1 'item type (1 means tool)
ItemIndex(1, 1) = 32 'item texture x cord
ItemIndex(1, 2) = 0 'item texture y cord
ItemIndex(1, 3) = 0 'tool max durabillity
ItemIndex(1, 4) = 1 'tool current durrabillity
ItemIndex(1, 5) = 1 'tool type
ItemIndex(1, 6) = 1000 'tool strength
ItemIndex(1, 7) = 1 'current stack
ItemIndex(1, 8) = 1 'max stack
ItemIndex(1, 9) = 1 'Item ID

ItemName(2, 0) = "Grass" 'Name of the Item
ItemName(2, 1) = "Placeholder" 'tooltip
ItemIndex(2, 0) = 0 'item type
ItemIndex(2, 1) = 48 'x position on tilesheet
ItemIndex(2, 2) = 0 'y position on tilesheet
ItemIndex(2, 3) = 2 'tile id
ItemIndex(2, 4) = 0 'layer
ItemIndex(2, 7) = 1 'current stack
ItemIndex(2, 8) = 100 'max stack
ItemIndex(2, 9) = 2 'Item ID


ItemName(3, 0) = "Cut Grass" 'Name of the Item
ItemName(3, 1) = "Placeholder" 'tooltip
ItemIndex(3, 0) = 0 'layer definition
ItemIndex(3, 1) = 64 'x position on tilesheet
ItemIndex(3, 2) = 0 'y position on tilesheet
ItemIndex(3, 3) = 3 'tile id
ItemIndex(3, 4) = 0
ItemIndex(3, 7) = 1 'current stack
ItemIndex(3, 8) = 100 'max stack
ItemIndex(3, 9) = 3 'Item ID


ItemName(4, 0) = "Dirt" 'Name of the tile
ItemName(4, 1) = "Placeholder" 'tooltip
ItemIndex(4, 0) = 0 'layer definition
ItemIndex(4, 1) = 80 'x position on tilesheet
ItemIndex(4, 2) = 0 'y position on tilesheet
ItemIndex(4, 3) = 4 'tile id
ItemIndex(4, 4) = 0 'tile id
ItemIndex(4, 7) = 1 'current stack
ItemIndex(4, 8) = 100 'max stack
ItemIndex(4, 9) = 4 'Item ID


ItemName(5, 0) = "Bush" 'Name of the tile
ItemName(5, 1) = "Placeholder" 'tooltip
ItemIndex(5, 0) = 0 'layer definition
ItemIndex(5, 1) = 96 'x position on tilesheet
ItemIndex(5, 2) = 0 'y position on tilesheet
ItemIndex(5, 3) = 5 'tile id
ItemIndex(5, 4) = 1 'tile id
ItemIndex(5, 7) = 1 'current stack
ItemIndex(5, 8) = 100 'max stack
ItemIndex(5, 9) = 5 'Item ID


ItemName(6, 0) = "Chest" 'Name of the tile
ItemName(6, 1) = "Placeholder" 'tooltip
ItemIndex(6, 0) = 0 'layer definition
ItemIndex(6, 1) = 112 'x position on tilesheet
ItemIndex(6, 2) = 0 'y position on tilesheet
ItemIndex(6, 3) = 6 'tile id
ItemIndex(6, 4) = 1 'tile id
ItemIndex(6, 7) = 1 'current stack
ItemIndex(6, 8) = 100 'max stack
ItemIndex(6, 9) = 6 'Item ID


ItemName(7, 0) = "Stone Wall" 'Name of the tile
ItemName(7, 1) = "Placeholder" 'tooltip
ItemIndex(7, 0) = 0 'layer definition
ItemIndex(7, 1) = 128 'x position on tilesheet
ItemIndex(7, 2) = 0 'y position on tilesheet
ItemIndex(7, 3) = 7 'tile id
ItemIndex(7, 4) = 1 'tile id
ItemIndex(7, 7) = 1 'current stack
ItemIndex(7, 8) = 100 'max stack
ItemIndex(7, 9) = 7 'Item ID


ItemName(8, 0) = "Wood Wall" 'Name of the tile
ItemName(8, 1) = "Placeholder" 'tooltip
ItemIndex(8, 0) = 0 'layer definition
ItemIndex(8, 1) = 144 'x position on tilesheet
ItemIndex(8, 2) = 0 'y position on tilesheet
ItemIndex(8, 3) = 8 'tile id
ItemIndex(8, 4) = 1 'tile id
ItemIndex(8, 7) = 1 'current stack
ItemIndex(8, 8) = 100 'max stack
ItemIndex(8, 9) = 8 'Item ID

ItemName(9, 0) = "Unlit Campfire" 'Name of the tile
ItemName(9, 1) = "Placeholder" 'tooltip
ItemIndex(9, 0) = 0 'item type
ItemIndex(9, 1) = 160 'x position on tilesheet
ItemIndex(9, 2) = 0 'y position on tilesheet
ItemIndex(9, 3) = 9 'tile id
ItemIndex(9, 4) = 1 'tile id
ItemIndex(9, 7) = 1 'current stack
ItemIndex(9, 8) = 100 'max stack
ItemIndex(9, 9) = 9 'Item ID

ItemName(10, 0) = "Campfire" 'Name of the tile
ItemName(10, 1) = "Placeholder" 'tooltip
ItemIndex(10, 0) = 0 'item type
ItemIndex(10, 1) = 176 'x position on tilesheet
ItemIndex(10, 2) = 0 'y position on tilesheet
ItemIndex(10, 3) = 10 'tile id
ItemIndex(10, 4) = 1 'tile id
ItemIndex(10, 7) = 1 'current stack
ItemIndex(10, 8) = 100 'max stack
ItemIndex(10, 9) = 10 'Item ID

ItemName(11, 0) = "Creative Pickaxe"
ItemName(11, 1) = "Allows you to mine"
ItemIndex(11, 0) = 1 'item type (1 means tool)
ItemIndex(11, 1) = 192 'item texture x cord
ItemIndex(11, 2) = 0 'item texture y cord
ItemIndex(11, 3) = 0 'tool max durabillity
ItemIndex(11, 4) = 1 'tool current durrabillity
ItemIndex(11, 5) = 2 'tool type
ItemIndex(11, 6) = 1000 'tool strength
ItemIndex(11, 7) = 1 'current stack
ItemIndex(11, 8) = 1 'max stack
ItemIndex(11, 9) = 11 'Item ID

ItemName(12, 0) = "Creative Sword"
ItemName(12, 1) = "Allows you to fight"
ItemIndex(12, 0) = 2 'item type (1 means tool)
ItemIndex(12, 1) = 208 'item texture x cord
ItemIndex(12, 2) = 0 'item texture y cord
ItemIndex(12, 3) = 0 'tool max durabillity
ItemIndex(12, 4) = 1 'tool current durrabillity
ItemIndex(12, 5) = 0 'swing delay
ItemIndex(12, 6) = 1000 'attack strength
ItemIndex(12, 7) = 1 'current stack
ItemIndex(12, 8) = 1 'max stack
ItemIndex(12, 9) = 12 'Item ID


ItemName(15, 0) = "Wood Shovel"
ItemName(15, 1) = "Allows you to break ground tiles"
ItemIndex(15, 0) = 1 'item type (1 means tool)
ItemIndex(15, 1) = 0 'item texture x cord
ItemIndex(15, 2) = 16 'item texture y cord
ItemIndex(15, 3) = 100 'tool max durabillity
ItemIndex(15, 4) = 100 'tool current durrabillity
ItemIndex(15, 5) = 0 'tool type
ItemIndex(15, 6) = 32 'tool strength
ItemIndex(15, 7) = 1 'current stack
ItemIndex(15, 8) = 1 'max stack
ItemIndex(15, 9) = 15 'Item ID

ItemName(16, 0) = "Creative Axe"
ItemName(16, 1) = "Allows you to break wall tiles"
ItemIndex(16, 0) = 1 'item type (1 means tool)
ItemIndex(16, 1) = 16 'item texture x cord
ItemIndex(16, 2) = 16 'item texture y cord
ItemIndex(16, 3) = 100 'tool max durabillity
ItemIndex(16, 4) = 100 'tool current durrabillity
ItemIndex(16, 5) = 1 'tool type
ItemIndex(16, 6) = 32 'tool strength
ItemIndex(16, 7) = 1 'current stack
ItemIndex(16, 8) = 1 'max stack
ItemIndex(16, 9) = 16 'Item ID

ItemName(17, 0) = "Creative Pickaxe"
ItemName(17, 1) = "Allows you to mine"
ItemIndex(17, 0) = 1 'item type (1 means tool)
ItemIndex(17, 1) = 32 'item texture x cord
ItemIndex(17, 2) = 16 'item texture y cord
ItemIndex(17, 3) = 100 'tool max durabillity
ItemIndex(17, 4) = 100 'tool current durrabillity
ItemIndex(17, 5) = 2 'tool type
ItemIndex(17, 6) = 32 'tool strength
ItemIndex(17, 7) = 1 'current stack
ItemIndex(17, 8) = 1 'max stack
ItemIndex(17, 9) = 17 'Item ID

ItemName(18, 0) = "Creative Sword"
ItemName(18, 1) = "Allows you to fight"
ItemIndex(18, 0) = 2 'item type (1 means tool)
ItemIndex(18, 1) = 48 'item texture x cord
ItemIndex(18, 2) = 16 'item texture y cord
ItemIndex(18, 3) = 100 'tool max durabillity
ItemIndex(18, 4) = 100 'tool current durrabillity
ItemIndex(18, 5) = .01 'swing delay
ItemIndex(18, 6) = 100 'attack strength
ItemIndex(18, 7) = 1 'current stack
ItemIndex(18, 8) = 1 'max stack
ItemIndex(18, 9) = 18 'item id
ItemIndex(18, 10) = 10 'range
ItemIndex(18, 11) = 3 'speed


ItemName(19, 0) = "Wood"
ItemName(19, 1) = "Crafting Material"
ItemIndex(19, 0) = 3 'item type (1 means tool)
ItemIndex(19, 1) = 64 'item texture x cord
ItemIndex(19, 2) = 16 'item texture y cord
ItemIndex(19, 3) = 1 'crafting ID
ItemIndex(19, 4) = 0 'minimum table
ItemIndex(19, 5) = 0 '
ItemIndex(19, 6) = 0 '
ItemIndex(19, 7) = 1 'current stack
ItemIndex(19, 8) = 100 'max stack
ItemIndex(19, 9) = 19 'Item ID

ItemName(20, 0) = "Berry Bush" 'Name of the tile
ItemName(20, 1) = "Placeholder" 'tooltip
ItemIndex(20, 0) = 0 'item type
ItemIndex(20, 1) = 80 'x position on tilesheet
ItemIndex(20, 2) = 16 'y position on tilesheet
ItemIndex(20, 3) = 12 'tile id
ItemIndex(20, 4) = 1 'layer
ItemIndex(20, 7) = 1 'current stack
ItemIndex(20, 8) = 100 'max stack
ItemIndex(20, 9) = 20 'Item ID

ItemName(21, 0) = "Crafting Station"

ItemIndex(21, 0) = 0 'type
ItemIndex(21, 1) = 96 'ssx
ItemIndex(21, 2) = 16 'ssy
ItemIndex(21, 3) = 15 'tileID
ItemIndex(21, 4) = 1 'layer
ItemIndex(21, 7) = 1 'current stack
ItemIndex(21, 8) = 100 'max stack
ItemIndex(21, 9) = 21 'Item ID









Sub NewContainer (MapX, Mapy, Tilex, Tiley)
    Dim total As Integer
    Dim i, ii, empty
    Dim containertype
    containertype = WallTile(Tilex, Tiley)
    empty = -1
    total = 1
    If DirExists("Assets\Worlds\" + WorldName + "\Containers") = 0 Then MkDir "Assets\Worlds\" + WorldName + "\Containers"
    Open "Assets\Worlds\" + WorldName + "\Containers\" + Str$(MapX) + Str$(Mapy) + Str$(Tilex) + Str$(Tiley) + ".cdf" As #1
    Put #1, total, ContainerData(containertype, 0): total = total + 1
    Put #1, total, ContainerData(containertype, 1): total = total + 1
    For i = 0 To ContainerData(containertype, 0)
        For ii = 0 To InvParameters
            Put #1, total, empty: total = total + 1
        Next
    Next
    Close #1
End Sub

Sub OpenContainer (MapX, Mapy, Tilex, Tiley)
    Dim total As Integer
    Dim i, ii, empty
    Dim ContainerSize
    Dim ContainerBreak
    empty = -1
    total = 1
    Open "Assets\Worlds\" + WorldName + "\Containers\" + Str$(MapX) + Str$(Mapy) + Str$(Tilex) + Str$(Tiley) + ".cdf" As #1
    Get #1, total, Container(18, 0): total = total + 1
    Get #1, total, Container(19, 0): total = total + 1
    For i = 0 To ContainerSize
        For ii = 0 To InvParameters
            Get #1, total, Container(i, ii): total = total + 1
        Next
    Next
    Close #1
End Sub

Sub CloseContainer (MapX, Mapy, Tilex, Tiley)
    Dim total As Integer
    Dim i, ii, empty
    Dim ContainerSize
    Dim ContainerBreak
    empty = -1
    total = 1
    Open "Assets\Worlds\" + WorldName + "\Containers\" + Str$(MapX) + Str$(Mapy) + Str$(Tilex) + Str$(Tiley) + ".cdf" As #1
    Put #1, total, Container(18, 0): total = total + 1
    Put #1, total, Container(19, 0): total = total + 1
    For i = 0 To ContainerSize
        For ii = 0 To InvParameters
            Put #1, total, Container(i, ii): total = total + 1
        Next
    Next
    Close #1

End Sub




Sub HUD
    If Flag.HudDisplay = 0 Then
        Dim i, ii, iii, iiii
        Dim tmpheal As Byte
        Dim token As Byte
        Dim hboffset As Byte
        Dim hbpos As Byte
        Static hbhpos As Byte
        Static FlashTimeout As Byte
        Dim hbitemsize As Single
        Dim invrow As Byte
        Dim invoffset As Byte
        Dim invheight As Byte
        Static CreativePage As Byte
        Static ItemSelectX As Byte
        Static ItemSelectY As Byte
        Static ItemSelectedX As Byte
        Static ItemSelectedY As Byte
        Static hbtimeout As Integer64
        Static adjustspace, adjustx, adjusty, invgap
        Static CursorMode As Byte
        Static ContainerOpened As Byte
        Static ContainerParams(4) As Single
        Static ActiveCursor As Byte
        Static ContainerItem As Byte
        Static SwapInitiated As Byte
        Static ContainerSelected As Byte
        Static CGPosX, CGPosY, ResultY
        CGPosX = 106
        CGPosY = 38
        ResultY = -17
        adjustx = 5
        adjusty = -45
        adjustspace = 68

        invgap = 83
        invoffset = 1
        invheight = 5
        hboffset = 1
        token = 1
        hbitemsize = 2
        If GameMode = 2 Then CreativePage = -1
        If GameMode = 1 And CreativePage < 0 Then CreativePage = 0

        tmpheal = Player.health

        'Health Display
        Select Case GameMode
            Case 1
                PutImage (CameraPositionX + 88 - 16, CameraPositionY - 52 + (token - 1) * 16)-(CameraPositionX + 88, CameraPositionY - 52 + 16 + (token - 1) * 16), Texture.HudSprites, , (4 * 32, 32)-(4 * 32 + 31, 63)
            Case 2
                While tmpheal > 0
                    If tmpheal <= 8 Then
                        PutImage (CameraPositionX + 88 - 16, CameraPositionY - 52 + (token - 1) * 16)-(CameraPositionX + 88, CameraPositionY - 52 + 16 + (token - 1) * 16), Texture.HudSprites, , ((tmpheal - 1) * 32, 0)-((tmpheal - 1) * 32 + 31, 31)
                    Else
                        PutImage (CameraPositionX + 88 - 16, CameraPositionY - 52 + (token - 1) * 16)-(CameraPositionX + 88, CameraPositionY - 52 + 16 + (token - 1) * 16), Texture.HudSprites, , (7 * 32, 0)-(7 * 32 + 31, 31)
                    End If
                    tmpheal = tmpheal - 8
                    token = token + 1
                Wend
        End Select

        'Hotbar Display
        For hbpos = 0 To 5
            PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), CameraPositionY + 68 - 16 - hboffset)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), CameraPositionY + 68 - hboffset), Texture.HudSprites, , (0, 32)-(31, 63)
            PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos) + hbitemsize, CameraPositionY + 68 - 16 - hboffset + hbitemsize)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos) - hbitemsize, CameraPositionY + 68 - hboffset - hbitemsize), Texture.ItemSheet, , (Inventory(0, hbpos, 1), Inventory(0, hbpos, 2))-(Inventory(0, hbpos, 1) + 15, Inventory(0, hbpos, 2) + 15)
            If Inventory(0, hbpos, 7) > 1 Then
                Color RGB(0, 0, 0)
                For i = 0 To 2
                    For ii = 0 To 2
                        PrintString ((0 + adjustx) + (adjustspace * hbpos) + i - 1, 480 - 16 + adjusty + ii - 1), Str$(Inventory(0, hbpos, 7))
                    Next
                Next
                Color RGB(255, 255, 255)
                PrintString ((0 + adjustx) + (adjustspace * hbpos), 480 - 16 + adjusty), Str$(Inventory(0, hbpos, 7))
            End If
        Next

        'Inventory Display
        If Flag.InventoryOpen = 1 Then
            If ContainerOpened = 1 Then
                If ContainerParams(0) <> SavedMapX Or ContainerParams(1) <> SavedMapY Or ContainerParams(2) <> FacingX Or ContainerParams(3) <> FacingY Then
                    'make check for if container is empty, and if it is set to delete on empty, then if it is, delete it
                    CloseContainer ContainerParams(0), ContainerParams(1), ContainerParams(2), ContainerParams(3)
                    ContainerOpened = 0
                End If
            End If
            If TileIndexData(WallTile(FacingX, FacingY), 7) = 1 Then
                If ContainerOpened = 0 Then
                    OpenContainer SavedMapX, SavedMapY, FacingX, FacingY
                    ContainerParams(0) = SavedMapX
                    ContainerParams(1) = SavedMapY
                    ContainerParams(2) = FacingX
                    ContainerParams(3) = FacingY
                    ContainerOpened = 1
                End If
                hbpos = 0
                invrow = 0
                Dim ContainerX
                Dim ContainerY
                Dim ContainerSelectedX
                Dim ContainerSelectedY
                ContainerX = ContainerItem
                While ContainerX > 5
                    ContainerX = ContainerX - 6
                Wend
                ContainerY = Int(ContainerItem / 6)

                ContainerSelectedX = ContainerSelected
                While ContainerSelectedX > 5
                    ContainerSelectedX = ContainerSelectedX - 6
                Wend
                ContainerSelectedY = Int(ContainerSelected / 6)

                'container display
                For i = 0 To Container(18, 0)
                    'background
                    PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (0, 32)-(31, 63)
                    'cursor
                    Select Case ActiveCursor
                        Case 0
                            If CursorMode = 1 Then
                                If SwapInitiated = 1 Then
                                    If invrow = ContainerSelectedY And hbpos = ContainerSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                                End If
                            End If
                        Case 1
                            Select Case CursorMode
                                Case 0
                                    If invrow = ContainerY And hbpos = ContainerX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                                Case 1
                                    If SwapInitiated = 1 Then
                                        If invrow = ContainerSelectedY And hbpos = ContainerSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                                    End If
                                    If invrow = ContainerY And hbpos = ContainerX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)

                            End Select
                    End Select

                    'item image
                    PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos) + hbitemsize, (CameraPositionY + 68 - 16 - hboffset + hbitemsize) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos) - hbitemsize, (CameraPositionY + 68 - hboffset - hbitemsize) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.ItemSheet, , (Container(i, 1), Container(i, 2))-(Container(i, 1) + 15, Container(i, 2) + 15)
                    'item quanity
                    If Container(i, 7) > 1 Then
                        Color RGB(0, 0, 0)
                        For iii = 0 To 2
                            For ii = 0 To 2
                                PrintString ((0 + adjustx) + (adjustspace * hbpos) + iii - 1, (480 - 16 + adjusty) - (adjustspace * (invrow + 3) + 9) - invgap + ii - 1), Str$(Container(i, 7))
                            Next
                        Next
                        Color RGB(255, 255, 255)
                        PrintString ((0 + adjustx) + (adjustspace * hbpos), (480 - 16 + adjusty) - (adjustspace * (invrow + 3) + 9) - invgap), Str$(Container(i, 7))
                    End If

                    hbpos = hbpos + 1
                    If hbpos > 5 Then invrow = invrow + 1: hbpos = 0
                Next
            Else

            End If
            'inventory display
            For invrow = 0 To 2
                For hbpos = 0 To 5

                    'place background squares
                    PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.HudSprites, , (0, 32)-(31, 63)

                    'place cursor
                    If ActiveCursor = 0 Then
                        Select Case CursorMode
                            Case 0
                                If invrow = ItemSelectY And hbpos = ItemSelectX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.HudSprites, , (32, 32)-(63, 63)
                            Case 1
                                If SwapInitiated = 0 Then
                                    If invrow = ItemSelectedY And hbpos = ItemSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.HudSprites, , (32, 32)-(63, 63)
                                End If
                                If invrow = ItemSelectY And hbpos = ItemSelectX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)
                        End Select
                    End If
                    If ActiveCursor = 1 Or ActiveCursor = 2 Then
                        If CursorMode = 1 Then
                            If SwapInitiated = 0 Then
                                If invrow = ItemSelectedY And hbpos = ItemSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.HudSprites, , (32, 32)-(63, 63)
                            End If
                        End If
                    End If
                    'display inventory contents
                    Select Case GameMode
                        Case 1
                            PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos) + hbitemsize, (CameraPositionY + 68 - 16 - hboffset + hbitemsize) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos) - hbitemsize, (CameraPositionY + 68 - hboffset - hbitemsize) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.ItemSheet, , (CreativeInventory(invrow, hbpos, 1, CreativePage), CreativeInventory(invrow, hbpos, 2, CreativePage))-(CreativeInventory(invrow, hbpos, 1, CreativePage) + 15, CreativeInventory(invrow, hbpos, 2, CreativePage) + 15)
                        Case 2
                            PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos) + hbitemsize, (CameraPositionY + 68 - 16 - hboffset + hbitemsize) - (16 * (invrow + 1) + invoffset * invrow) - invheight)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos) - hbitemsize, (CameraPositionY + 68 - hboffset - hbitemsize) - (16 * (invrow + 1) + invoffset * invrow) - invheight), Texture.ItemSheet, , (Inventory(invrow + 1, hbpos, 1), Inventory(invrow + 1, hbpos, 2))-(Inventory(invrow + 1, hbpos, 1) + 15, Inventory(invrow + 1, hbpos, 2) + 15)
                            If Inventory(invrow + 1, hbpos, 7) > 1 Then
                                Color RGB(0, 0, 0)
                                For i = 0 To 2
                                    For ii = 0 To 2
                                        PrintString ((0 + adjustx) + (adjustspace * hbpos) + i - 1, (480 - 16 + adjusty) - (adjustspace * invrow + 1) - invgap + ii - 1), Str$(Inventory(invrow + 1, hbpos, 7))
                                    Next
                                Next
                                Color RGB(255, 255, 255)
                                PrintString ((0 + adjustx) + (adjustspace * hbpos), (480 - 16 + adjusty) - (adjustspace * invrow + 1) - invgap), Str$(Inventory(invrow + 1, hbpos, 7))
                            End If
                    End Select
                Next
            Next
            If 1 = 0 Then
                If Flag.InventoryOpen = 1 Then
                    Crafting
                    Select Case Player.CraftingLevel
                        Case 0 TO 5
                            For i = 0 To Player.CraftingLevel + 1
                                For ii = 0 To Player.CraftingLevel + 1
                                    PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (0, 32)-(31, 63)
                                    PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i) + hbitemsize, CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii) + hbitemsize)-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i) - hbitemsize, CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii) - hbitemsize), Texture.ItemSheet, , (CraftingGrid(ii, i, 1), CraftingGrid(ii, i, 2))-(CraftingGrid(ii, i, 1) + 15, CraftingGrid(ii, i, 2) + 15)

                                Next
                            Next
                            PutImage (CameraPositionX - 72 + CGPosX + 17, CameraPositionY + 68 - 16 - CGPosY + ResultY)-(CameraPositionX - 72 + 16 + CGPosX + 17, CameraPositionY + 68 - CGPosY + ResultY), Texture.HudSprites, , (0, 32)-(31, 63)
                    End Select
                End If
            End If

            Select Case ActiveCursor
                Case 0
                    If CursorMode = 1 Then
                        If SwapInitiated = 1 Then
                            If invrow = ContainerSelectedY And hbpos = ContainerSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                        End If
                    End If
                Case 1
                    Select Case CursorMode
                        Case 0
                            If invrow = ContainerY And hbpos = ContainerX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                        Case 1
                            If SwapInitiated = 1 Then
                                If invrow = ContainerSelectedY And hbpos = ContainerSelectedX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32, 32)-(63, 63)
                            End If
                            If invrow = ContainerY And hbpos = ContainerX Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbpos), (CameraPositionY + 68 - 16 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2)-(CameraPositionX - 72 + 16 + hboffset + (17 * hbpos), (CameraPositionY + 68 - hboffset) - (16 * (invrow + 4) + invoffset * invrow) - invheight * 2), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)

                    End Select
            End Select

            'crafting display
            For i = 0 To Player.CraftingLevel + 1
                For ii = 0 To Player.CraftingLevel + 1

                    'place bg
                    PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (0, 32)-(31, 63)
                    'place cursor
                    If ActiveCursor = 2 Then
                        Select Case CursorMode
                            Case 0
                                If ii = ItemSelectY And i = ItemSelectX Then PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (32, 32)-(63, 63)
                            Case 1
                                If SwapInitiated = 1 Then
                                    If ii = ItemSelectedY And i = ItemSelectedX Then PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (32, 32)-(63, 63)
                                End If
                                If ii = ItemSelectY And i = ItemSelectX Then PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (32 + 32, 32)-(63 + 32, 63)
                        End Select
                    End If
                    If ActiveCursor = 0 Then
                        If CursorMode = 1 Then
                            If SwapInitiated = 1 Then
                                If ii = ItemSelectedY And i = ItemSelectedX Then PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.HudSprites, , (32, 32)-(63, 63)
                            End If
                        End If
                    End If
                    'display inventory contents
                    PutImage (CameraPositionX - 72 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - 16 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii))-(CameraPositionX - 72 + 16 + CGPosX + CraftSpace(Player.CraftingLevel) + (17 * i), CameraPositionY + 68 - CGPosY + CraftSpace(Player.CraftingLevel) + (17 * ii)), Texture.ItemSheet, , (CraftingGrid(ii + 1, i, 1), CraftingGrid(ii + 1, i, 2))-(CraftingGrid(ii + 1, i, 1) + 15, CraftingGrid(ii + 1, i, 2) + 15)
                    If Inventory(ii, i, 7) > 1 Then
                        Color RGB(0, 0, 0)
                        For iii = 0 To 2
                            For iiii = 0 To 2
                                '  PrintString ((0 + adjustx) + (adjustspace * hbpos) + iii - 1, (480 - 16 + adjusty) - (adjustspace * invrow + 1) - invgap + iiii - 1), Str$(Inventory(invrow + 1, hbpos, 7))
                            Next
                        Next
                        Color RGB(255, 255, 255)
                        ' PrintString ((0 + adjustx) + (adjustspace * hbpos), (480 - 16 + adjusty) - (adjustspace * invrow + 1) - invgap), Str$(Inventory(invrow + 1, hbpos, 7))
                    End If

                Next
            Next


            Select Case KeyPressed
                Case 9
                    ActiveCursor = ActiveCursor + 1
                    If ActiveCursor > 3 Then ActiveCursor = 0
                    If ContainerOpened = 0 And ActiveCursor = 1 Then ActiveCursor = 2
                    If ContainerOpened = 1 And ActiveCursor = 2 Then ActiveCursor = 0
            End Select
            If ActiveCursor = 0 Then
                Select Case KeyPressed
                    Case 92
                        If Inventory(ItemSelectY + 1, ItemSelectX, 7) > 1 Then
                            NewStack Inventory(ItemSelectY + 1, ItemSelectX, 9), Int(Inventory(ItemSelectY + 1, ItemSelectX, 7) / 2)
                            Inventory(ItemSelectY + 1, ItemSelectX, 7) = Ceil(Inventory(ItemSelectY + 1, ItemSelectX, 7) / 2)
                        End If
                    Case 13
                        Select Case CursorMode
                            Case 0
                                CursorMode = 1
                                ItemSelectedX = ItemSelectX
                                ItemSelectedY = ItemSelectY
                                SwapInitiated = 0
                                Exit Select
                            Case 1
                                CursorMode = 0
                                If SwapInitiated = 0 Then
                                    If ItemSelectX = ItemSelectedX And ItemSelectY = ItemSelectedY Then Exit Select
                                    If Inventory(ItemSelectY + 1, ItemSelectX, 9) = Inventory(ItemSelectedY + 1, ItemSelectedX, 9) Then
                                        Inventory(ItemSelectY + 1, ItemSelectX, 7) = Inventory(ItemSelectY + 1, ItemSelectX, 7) + Inventory(ItemSelectedY + 1, ItemSelectedX, 7)
                                        If Inventory(ItemSelectY + 1, ItemSelectX, 7) > Inventory(ItemSelectY + 1, ItemSelectX, 8) Then
                                            Inventory(ItemSelectedY + 1, ItemSelectedX, 7) = Inventory(ItemSelectY + 1, ItemSelectX, 7) - Inventory(ItemSelectY + 1, ItemSelectX, 8)
                                            Inventory(ItemSelectY + 1, ItemSelectX, 7) = Inventory(ItemSelectY + 1, ItemSelectX, 8)
                                        Else
                                            EmptySlot ItemSelectedX, ItemSelectedY + 1
                                        End If
                                    Else
                                        InvSwap ItemSelectedX, GameMode - 1, ItemSelectX, ItemSelectY, ItemSelectedY
                                    End If
                                    Exit Select
                                End If
                                If SwapInitiated = 1 Then

                                    ConSwap ContainerSelected, ItemSelectX, ItemSelectY + 1, 1
                                End If

                        End Select
                    Case 49
                        InvSwap 0, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 50
                        InvSwap 1, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 51
                        InvSwap 2, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 52
                        InvSwap 3, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 53
                        InvSwap 4, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 54
                        InvSwap 5, GameMode - 1, ItemSelectX, ItemSelectY, CreativePage
                    Case 18432
                        ItemSelectY = ItemSelectY + 1
                    Case 20480
                        ItemSelectY = ItemSelectY - 1
                    Case 19200
                        ItemSelectX = ItemSelectX - 1
                    Case 19712
                        ItemSelectX = ItemSelectX + 1

                End Select

                If ItemSelectX > 5 Then ItemSelectX = 0
                If ItemSelectX < 0 Then ItemSelectX = 5
                If ItemSelectY > 2 Then ItemSelectY = 0
                If ItemSelectY < 0 Then ItemSelectY = 2
            End If
            If ActiveCursor = 1 Then
                Select Case KeyPressed
                    Case 92
                        'alert cannot split in container
                    Case 13
                        Select Case CursorMode
                            Case 0
                                CursorMode = 1
                                ContainerSelected = ContainerItem
                                SwapInitiated = 1
                                Exit Select

                            Case 1
                                CursorMode = 0
                                If SwapInitiated = 1 Then
                                    If ContainerItem = ContainerSelected Then Exit Select
                                    If Container(ContainerItem, 9) = Container(ContainerSelected, 9) Then
                                        Container(ContainerItem, 7) = Container(ContainerItem, 7) + Container(ContainerSelected, 7)
                                        If Container(ContainerItem, 7) > Container(ContainerItem, 8) Then
                                            Container(ContainerSelected, 7) = Container(ContainerItem, 7) - Container(ContainerItem, 8)
                                            Container(ContainerItem, 7) = Container(ContainerItem, 8)
                                        Else
                                            EmptyContainerSlot ContainerItem
                                        End If
                                    Else
                                        ConSwap ContainerItem, ContainerSelected, 0, 0
                                    End If
                                End If
                                If SwapInitiated = 0 Then
                                    ConSwap ContainerItem, ItemSelectedX, ItemSelectedY + 1, 1
                                End If
                                Exit Select
                        End Select
                    Case 18432

                        ContainerItem = ContainerItem + 6
                    Case 20480

                        ContainerItem = ContainerItem - 6
                    Case 19200
                        ContainerItem = ContainerItem - 1
                    Case 19712
                        ContainerItem = ContainerItem + 1

                End Select
                If ContainerItem < 0 Then ContainerItem = Container(18, 0)
                If ContainerItem > Container(18, 0) Then ContainerItem = 0

            End If
        End If
        If ActiveCursor = 2 Then
            Select Case KeyPressed
                Case 92
                    If CraftingGrid(ItemSelectY, ItemSelectX, 7) > 1 Then
                        NewStack CraftingGrid(ItemSelectY, ItemSelectX, 9), Int(CraftingGrid(ItemSelectY, ItemSelectX, 7) / 2)
                        CraftingGrid(ItemSelectY, ItemSelectX, 7) = Ceil(CraftingGrid(ItemSelectY, ItemSelectX, 7) / 2)
                    End If
                Case 13
                    Select Case CursorMode
                        Case 0
                            CursorMode = 1
                            ItemSelectedX = ItemSelectX
                            ItemSelectedY = ItemSelectY
                            SwapInitiated = 0
                            Exit Select
                        Case 1
                            CursorMode = 0
                            If SwapInitiated = 0 Then
                                If ItemSelectX = ItemSelectedX And ItemSelectY = ItemSelectedY Then Exit Select
                                If CraftingGrid(ItemSelectY, ItemSelectX, 9) = CraftingGrid(ItemSelectedY, ItemSelectedX, 9) Then
                                    CraftingGrid(ItemSelectY, ItemSelectX, 7) = CraftingGrid(ItemSelectY, ItemSelectX, 7) + CraftingGrid(ItemSelectedY, ItemSelectedX, 7)
                                    If CraftingGrid(ItemSelectY, ItemSelectX, 7) > CraftingGrid(ItemSelectY, ItemSelectX, 8) Then
                                        CraftingGrid(ItemSelectedY, ItemSelectedX, 7) = CraftingGrid(ItemSelectY, ItemSelectX, 7) - CraftingGrid(ItemSelectY, ItemSelectX, 8)
                                        CraftingGrid(ItemSelectY, ItemSelectX, 7) = CraftingGrid(ItemSelectY, ItemSelectX, 8)
                                    Else
                                        EmptySlot ItemSelectedX, ItemSelectedY + 1 'set all of these to support inv or craft and add veriable to tell
                                    End If
                                Else
                                    InvSwap ItemSelectedX, GameMode - 1, ItemSelectX, ItemSelectY, ItemSelectedY
                                End If
                                Exit Select
                            End If
                            If SwapInitiated = 1 Then

                                ConSwap ContainerSelected, ItemSelectX, ItemSelectY, 1
                            End If

                    End Select
                Case 18432
                    ItemSelectY = ItemSelectY - 1
                Case 20480
                    ItemSelectY = ItemSelectY + 1
                Case 19200
                    ItemSelectX = ItemSelectX - 1
                Case 19712
                    ItemSelectX = ItemSelectX + 1

            End Select

            If ItemSelectX > Player.CraftingLevel + 1 Then ItemSelectX = 0
            If ItemSelectX < 0 Then ItemSelectX = Player.CraftingLevel + 1
            If ItemSelectY > Player.CraftingLevel + 1 Then ItemSelectY = 0
            If ItemSelectY < 0 Then ItemSelectY = Player.CraftingLevel + 1
        End If




        If Flag.InventoryOpen = 0 Then

            If Item1 Then
                UseItem 0
                hbhpos = 0
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If Item2 Then
                UseItem 1
                hbhpos = 1
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If Item3 Then
                UseItem 2
                hbhpos = 2
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If Item4 Then
                UseItem 3
                hbhpos = 3
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If Item5 Then
                UseItem 4
                hbhpos = 4
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If Item6 Then
                UseItem 5
                hbhpos = 5
                hbtimeout = CurrentTick + 10
                FlashTimeout = 5
            End If
            If hbtimeout > CurrentTick And FlashTimeout > 0 Then PutImage (CameraPositionX - 72 + hboffset + (17 * hbhpos), (CameraPositionY + 68 - 16 - hboffset))-(CameraPositionX - 72 + 16 + hboffset + (17 * hbhpos), (CameraPositionY + 68 - hboffset)), Texture.HudSprites, , (32, 32)-(63, 63) Else hbtimeout = CurrentTick + 3: FlashTimeout = FlashTimeout - 1
            If FlashTimeout < 0 Then FlashTimeout = 0



        End If
    End If

End Sub


Sub ConSwap (ContainerItem, ContainerSelected, InventoryY, Mode)
    'Dim Shared Inventory(3, 5,9) As Integer
    'dim shared CreativeInventory(2,5,9,1)
    Dim i
    For i = 0 To InvParameters
        Select Case Mode
            Case 0
                Swap Container(ContainerItem, i), Container(ContainerSelected, i)
            Case 1
                Swap Container(ContainerItem, i), Inventory(InventoryY, ContainerSelected, i)
        End Select
    Next
End Sub

Sub EmptyContainerSlot (slot)
    Dim i
    For i = 0 To InvParameters
        Container(slot, i) = -1
    Next
End Sub



Sub InvSwap (Slot, Mode, ItemSelectX, ItemSelectY, CreativePage)
    'Dim Shared Inventory(3, 5,9) As Integer
    'dim shared CreativeInventory(2,5,9,1)
    Dim i
    For i = 0 To InvParameters
        Select Case Mode
            Case 0
                Swap CreativeInventory(ItemSelectY, ItemSelectX, i, CreativePage), Inventory(0, Slot, i)
            Case 1
                Swap Inventory(ItemSelectY + 1, ItemSelectX, i), Inventory(CreativePage + 1, Slot, i)
        End Select
    Next
End Sub

 

Sub SetBG
    If bgdraw = 0 Then
        Dim i As Integer
        Dim ii As Integer
        For i = 0 To 30
            For ii = 0 To 40
                PutImage (ii * 16, i * 16)-((ii * 16) + 15.75, (i * 16) + 15.75), Texture.TileSheet, , (16, 0)-(31, 15)
            Next
        Next
    End If
End Sub


Sub SetMap
    Dim i As integer
    Dim ii As integer
    For i = 1 To 30
        For ii = 1 To 40
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.TileSheet, , (TileIndex(GroundTile(ii, i), 1), TileIndex(GroundTile(ii, i), 2))-(TileIndex(GroundTile(ii, i), 1) + 15, TileIndex(GroundTile(ii, i), 2) + 15)
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (Int(TileData(ii, i, 4) / 32) * 16, 32)-((Int(TileData(ii, i, 4) / 32) * 16) + 15, 47)
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.TileSheet, , (TileIndex(WallTile(ii, i), 1), TileIndex(WallTile(ii, i), 2))-(TileIndex(WallTile(ii, i), 1) + 15, TileIndex(WallTile(ii, i), 2) + 15)
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (Int(TileData(ii, i, 5) / 32) * 16, 32)-((Int(TileData(ii, i, 5) / 32) * 16) + 15, 47)
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.TileSheet, , (TileIndex(CeilingTile(ii, i), 1), TileIndex(CeilingTile(ii, i), 2))-(TileIndex(CeilingTile(ii, i), 1) + 15, TileIndex(CeilingTile(ii, i), 2) + 15)
            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (Int(TileData(ii, i, 6) / 32) * 16, 32)-((Int(TileData(ii, i, 6) / 32) * 16) + 15, 47)
        Next
    Next
End Sub

Sub SwitchRender (mode As Byte)
    Static FirstSkip As Byte
    If mode <> 0 And mode <> 1 Then Exit Sub

    If FirstSkip = 1 Then 'this is to prevent the game from crashing if the files arent loaded yet, because this is also run to initially load the files
        FreeImage Texture.PlayerSprites
        FreeImage Texture.TileSheet
        FreeImage Texture.ItemSheet
        FreeImage Texture.HudSprites
        FreeImage Texture.Shadows
    End If

    Texture.PlayerSprites = LoadImage(File.PlayerSprites, mode + 32)
    Texture.TileSheet = LoadImage(File.TileSheet, mode + 32)
    Texture.ItemSheet = LoadImage(File.ItemSheet, mode + 32)
    Texture.HudSprites = LoadImage(File.HudSprites, mode + 32)
    Texture.Shadows = LoadImage(File.Shadows, mode + 32)
    FirstSkip = 1

End Sub

Sub OSPROBE

    Game.HostOS = "Unknown OS"
    If InStr(OS$, "WINDOWS") Then Game.HostOS = "Windows"
    If InStr(OS$, "LINUX") Then Game.HostOS = "Linux"
    If InStr(OS$, "MACOSX") Then Game.HostOS = "Mac OS"
    if InStr(OS$, "32-BIT") Then Game.32Bit = 1
    
End Sub


Function Perlin (x As Single, y As Single, z As Single, seed As Single)
    Randomize seed

    Static p5NoiseSetup As _Byte
    Static perlini() As Single
    Static PERLIN_YWRAPB As Single, PERLIN_YWRAP As Single
    Static PERLIN_ZWRAPB As Single, PERLIN_ZWRAP As Single
    Static PERLIN_SIZE As Single

    If Not p5NoiseSetup Then
        p5NoiseSetup = -1

        PERLIN_YWRAPB = 4
        PERLIN_YWRAP = Int(1 * (2 ^ PERLIN_YWRAPB))
        PERLIN_ZWRAPB = 8
        PERLIN_ZWRAP = Int(1 * (2 ^ PERLIN_ZWRAPB))
        PERLIN_SIZE = 4095

        perlin_octaves = 4
        perlin_amp_falloff = 0.5

        ReDim perlini(PERLIN_SIZE + 1) As Single
        Dim i As Single
        For i = 0 To PERLIN_SIZE + 1
            perlini(i) = Rnd
        Next
    End If

    x = Abs(x)
    y = Abs(y)
    z = Abs(z)

    Dim xi As Single, yi As Single, zi As Single
    xi = Int(x)
    yi = Int(y)
    zi = Int(z)

    Dim xf As Single, yf As Single, zf As Single
    xf = x - xi
    yf = y - yi
    zf = z - zi

    Dim r As Single, ampl As Single, o As Single
    r = 0
    ampl = .5

    For o = 1 To perlin_octaves
        Dim of As Single, rxf As Single
        Dim ryf As Single, n1 As Single, n2 As Single, n3 As Single
        of = xi + Int(yi * (2 ^ PERLIN_YWRAPB)) + Int(zi * (2 ^ PERLIN_ZWRAPB))

        rxf = 0.5 * (1.0 - Cos(xf * _Pi))
        ryf = 0.5 * (1.0 - Cos(yf * _Pi))

        n1 = perlini(of And PERLIN_SIZE)
        n1 = n1 + rxf * (perlini((of + 1) And PERLIN_SIZE) - n1)
        n2 = perlini((of + PERLIN_YWRAP) And PERLIN_SIZE)
        n2 = n2 + rxf * (perlini((of + PERLIN_YWRAP + 1) And PERLIN_SIZE) - n2)
        n1 = n1 + ryf * (n2 - n1)

        of = of + PERLIN_ZWRAP
        n2 = perlini(of And PERLIN_SIZE)
        n2 = n2 + rxf * (perlini((of + 1) And PERLIN_SIZE) - n2)
        n3 = perlini((of + PERLIN_YWRAP) And PERLIN_SIZE)
        n3 = n3 + rxf * (perlini((of + PERLIN_YWRAP + 1) And PERLIN_SIZE) - n3)
        n2 = n2 + ryf * (n3 - n2)

        n1 = n1 + (0.5 * (1.0 - Cos(zf * _Pi))) * (n2 - n1)

        r = r + n1 * ampl
        ampl = ampl * perlin_amp_falloff
        xi = Int(xi * (2 ^ 1))
        xf = xf * 2
        yi = Int(yi * (2 ^ 1))
        yf = yf * 2
        zi = Int(zi * (2 ^ 1))
        zf = zf * 2

        If xf >= 1.0 Then xi = xi + 1: xf = xf - 1
        If yf >= 1.0 Then yi = yi + 1: yf = yf - 1
        If zf >= 1.0 Then zi = zi + 1: zf = zf - 1
    Next
    Perlin = r
End Function


 

Sub ZOOM
    If Flag.StillCam = 0 And Flag.FreeCam = 0 Then
        CameraPositionX = Player.x
        CameraPositionY = Player.y
    End If

    If CameraPositionX - (ScreenRezX / 4 / 2) + 8 < 0 Then CameraPositionX = (ScreenRezX / 4 / 2) - 8
    If CameraPositionY - (ScreenRezY / 4 / 2) + 8 < 0 Then CameraPositionY = (ScreenRezY / 4 / 2) - 8
    If CameraPositionX + (ScreenRezX / 4 / 2) + 8 > 640 Then CameraPositionX = 640 - ((ScreenRezX / 4 / 2) + 8)
    If CameraPositionY + (ScreenRezY / 4 / 2) + 8 > 480 Then CameraPositionY = 480 - ((ScreenRezY / 4 / 2) + 8)

    If Flag.FullCam = 0 Then Window Screen(CameraPositionX - ((ScreenRezX / 4 / 2) - 8), CameraPositionY - ((ScreenRezY / 4 / 2) - 8))-(CameraPositionX + ((ScreenRezX / 4 / 2) + 8), CameraPositionY + ((ScreenRezY / 4 / 2) + 8)) Else Window
End Sub


Sub CastShadow
    If Flag.CastShadows = 0 Then
        Dim i As Byte
        Dim ii As Byte
        For i = 1 To 30
            For ii = 1 To 40

                If TileData(ii, i + 1, 1) = 1 And TileData(ii, i, 2) = 0 Then
                    PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (0, 0)-(15, 15)
                End If

                If TileData(ii + 1, i, 1) = 1 And TileData(ii, i, 2) = 0 Then
                    PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (16, 0)-(31, 15)
                End If

                If TileData(ii - 1, i, 1) = 1 And TileData(ii, i, 2) = 0 Then
                    PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (32, 0)-(47, 15)
                End If

                If TileData(ii, i - 1, 1) = 1 And TileData(ii, i, 2) = 0 Then
                    PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (48, 0)-(63, 15)
                End If

                If TileData(ii, i, 3) = 1 Then

                    If TileData(ii, i + 1, 3) = 0 Then
                        PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (0, 0)-(15, 15)
                    End If

                    If TileData(ii + 1, i, 3) = 0 Then
                        PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (16, 0)-(31, 15)
                    End If

                    If TileData(ii - 1, i, 3) = 0 Then
                        PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (32, 0)-(47, 15)
                    End If

                    If TileData(ii, i - 1, 3) = 0 Then
                        PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (48, 0)-(63, 15)
                    End If

                End If
            Next
        Next
    End If
End Sub


Sub SpreadLight (updates)
    Dim as byte i, ii
    For i = 1 To 30
        For ii = 1 To 40
            LocalLightLevel(ii, i) = TileData(ii, i, 8)
        Next
    Next
    SpreadLight2 (updates)
End Sub
Sub SpreadLight2 (updates)
    Dim as byte i, ii, iii, iiii
    Static UpdateLimit
    If updates > 0 Then
        updates = 0
        For i = 1 To 30
            For ii = 1 To 40
                iiii = 1
                iii = 0

                For iii = 0 To 2

                    If LocalLightLevel(ii, i) < LocalLightLevel(ii + (iii - 1), i) Then LocalLightLevel(ii, i) = LocalLightLevel(ii + (iii - 1), i) - 1
                    If LocalLightLevel(ii, i) < LocalLightLevel(ii + (iii - 1), i + (iiii - 1)) - 2 Then updates = updates + 1
                Next

                iiii = 0
                iii = 1
                For iiii = 0 To 2
                    If LocalLightLevel(ii, i) < LocalLightLevel(ii, i + (iiii - 1)) Then LocalLightLevel(ii, i) = LocalLightLevel(ii, i + (iiii - 1)) - 1

                    If LocalLightLevel(ii, i) < LocalLightLevel(ii + (iii - 1), i + (iiii - 1)) - 2 Then updates = updates + 1
                Next
                'LocalLightLevel(ii, i) = TileData(ii, i, 8)
            Next
        Next
        If updates = 0 Then UpdateLimit = UpdateLimit + 1: updates = 1
        If UpdateLimit > 10 Then updates = 0
        ' Print updates, UpdateLimit
        ' Display
        ' Sleep

        SpreadLight2 (updates)
    Else
        UpdateLimit = 0
    End If
End Sub


Sub SetLighting
    Dim i As Byte
    Dim ii As Byte
    Dim TotalLightLevel
    For i = 0 To 31
        For ii = 0 To 41
            If GlobalLightLevel < LocalLightLevel(ii, i) Then TotalLightLevel = LocalLightLevel(ii, i) Else TotalLightLevel = GlobalLightLevel
            TotalLightLevel = TotalLightLevel - OverlayLightLevel
            If TotalLightLevel > 12 Then TotalLightLevel = 12
            If TotalLightLevel < 0 Then TotalLightLevel = 0

            PutImage ((ii - 1) * 16, (i - 1) * 16)-(((ii - 1) * 16) + 15.75, ((i - 1) * 16) + 15.75), Texture.Shadows, , (TotalLightLevel * 16, 16)-((16 * TotalLightLevel) + 15, 31)
        Next
    Next
End Sub

 

Sub CENTERPRINT (nam$)
    _PrintMode _KeepBackground
    Dim i As _Byte
    For i = 0 To Int(40 - (Len(nam$) / 2) - 1)
        Print " ";
    Next
    _PrintMode _FillBackground
    Print nam$
End Sub

Sub ENDPRINT (nam$)
    _PrintMode _KeepBackground
    Dim i As _Byte
    For i = 0 To Int(80 - (Len(nam$))) - 1
        Print " ";
    Next
    _PrintMode _FillBackground
    Print nam$
End Sub



Dim Shared TileIndex(1000, 4)
Dim Shared TileIndexData(1000, TileParameters) As Single
Dim Shared ContainerData(1000, 3)
Dim Shared TileName(1000, 3) As String

TileName(0, 0) = "Ground Air" 'Name of the tile
TileName(0, 1) = "Pure nothingness" 'tooltip
TileIndex(0, 0) = 0 'layer definition
TileIndex(0, 1) = 0 'x position on tilesheet
TileIndex(0, 2) = 0 'y position on tilesheet
TileIndexData(0, 0) = 1 'collision
TileIndexData(0, 1) = 0 'casts shadow
TileIndexData(0, 2) = 0 'blocks shadow
TileIndexData(0, 3) = 1 'has interior shadow
TileIndexData(0, 4) = 0 'resistance
TileIndexData(0, 5) = 0 'is solid
TileIndexData(0, 9) = 0 'Friction
TileIndexData(0, 10) = 10

TileName(1, 0) = "Air" 'Name of the tile
TileName(1, 1) = "Placeholder" 'tooltip
TileIndex(1, 0) = 1 'layer definition
TileIndex(1, 1) = 0 'x position on tilesheet
TileIndex(1, 2) = 0 'y position on tilesheet
TileIndexData(1, 0) = 0 'collision
TileIndexData(1, 1) = 0 'casts shadow
TileIndexData(1, 2) = 0 'blocks shadow
TileIndexData(1, 3) = 0 'has interior shadow
TileIndexData(1, 4) = 0 'resistance
TileIndexData(1, 5) = 0 'is solid

TileName(2, 0) = "Grass" 'Name of the tile
TileName(2, 1) = "Placeholder" 'tooltip
TileIndex(2, 0) = 0 'layer definition
TileIndex(2, 1) = 32 'x position on tilesheet
TileIndex(2, 2) = 0 'y position on tilesheet
TileIndex(2, 3) = 2 'itemid
TileIndexData(2, 0) = 0 'collision
TileIndexData(2, 1) = 0 'casts shadow
TileIndexData(2, 2) = 0 'blocks shadow
TileIndexData(2, 3) = 0 'has interior shadow
TileIndexData(2, 4) = 20 'resistance
TileIndexData(2, 5) = 1 'is solid
TileIndexData(2, 9) = 0.25 'friction
TileIndexData(2, 10) = 1

TileName(3, 0) = "Cut Grass" 'Name of the tile
TileName(3, 1) = "Placeholder" 'tooltip
TileIndex(3, 0) = 0 'layer definition
TileIndex(3, 1) = 48 'x position on tilesheet
TileIndex(3, 2) = 0 'y position on tilesheet
TileIndex(3, 3) = 3 'itemid
TileIndexData(3, 0) = 0 'collision
TileIndexData(3, 1) = 0 'casts shadow
TileIndexData(3, 2) = 0 'blocks shadow
TileIndexData(3, 3) = 0 'has interior shadow
TileIndexData(3, 4) = 20 'resistance
TileIndexData(3, 5) = 1 'is solid
TileIndexData(3, 9) = 0.25 'Friction
TileIndexData(3, 10) = 1.2

TileName(4, 0) = "Dirt" 'Name of the tile
TileName(4, 1) = "Placeholder" 'tooltip
TileIndex(4, 0) = 0 'layer definition
TileIndex(4, 1) = 64 'x position on tilesheet
TileIndex(4, 2) = 0 'y position on tilesheet
TileIndex(4, 3) = 4 'itemid
TileIndexData(4, 0) = 0 'collision
TileIndexData(4, 1) = 0 'casts shadow
TileIndexData(4, 2) = 0 'blocks shadow
TileIndexData(4, 3) = 0 'has interior shadow
TileIndexData(4, 4) = 17 'resistance
TileIndexData(4, 5) = 1 'is solid
TileIndexData(4, 9) = 0.8 'Friction
TileIndexData(4, 10) = 0.8




TileName(5, 0) = "Bush" 'Name of the tile
TileName(5, 1) = "Placeholder" 'tooltip
TileIndex(5, 0) = 1 'layer definition
TileIndex(5, 1) = 80 'x position on tilesheet
TileIndex(5, 2) = 0 'y position on tilesheet
TileIndex(5, 3) = 5 'itemid
TileIndexData(5, 0) = 1 'collision
TileIndexData(5, 1) = 0 'casts shadow
TileIndexData(5, 2) = 1 'blocks shadow
TileIndexData(5, 3) = 0 'has interior shadow
TileIndexData(5, 4) = 25 'resistance
TileIndexData(5, 5) = 0 'is solid
TileIndexData(0, 9) = 0 'Friction

TileName(6, 0) = "Chest" 'Name of the tile
TileName(6, 1) = "Placeholder" 'tooltip
TileIndex(6, 0) = 1 'layer definition
TileIndex(6, 1) = 96 'x position on tilesheet
TileIndex(6, 2) = 0 'y position on tilesheet
TileIndex(6, 3) = 6 'itemid
TileIndexData(6, 0) = 1 'collision
TileIndexData(6, 1) = 0 'casts shadow
TileIndexData(6, 2) = 1 'blocks shadow
TileIndexData(6, 3) = 0 'has interior shadow
TileIndexData(6, 4) = 25 'resistance
TileIndexData(6, 5) = 0 'is solid
TileIndexData(6, 7) = 1 'is container
ContainerData(6, 0) = 11 'number of slots  -1
ContainerData(6, 1) = 0 'dissapears on empty


TileName(7, 0) = "Stone Wall" 'Name of the tile
TileName(7, 1) = "Placeholder" 'tooltip
TileIndex(7, 0) = 1 'layer definition
TileIndex(7, 1) = 112 'x position on tilesheet
TileIndex(7, 2) = 0 'y position on tilesheet
TileIndex(7, 3) = 7 'itemid
TileIndexData(7, 0) = 1 'collision
TileIndexData(7, 1) = 1 'casts shadow
TileIndexData(7, 2) = 1 'blocks shadow
TileIndexData(7, 3) = 0 'has interior shadow
TileIndexData(7, 4) = 40 'resistance
TileIndexData(7, 5) = 1 'is solid


TileName(8, 0) = "Wood Wall" 'Name of the tile
TileName(8, 1) = "Placeholder" 'tooltip
TileIndex(8, 0) = 1 'layer definition
TileIndex(8, 1) = 128 'x position on tilesheet
TileIndex(8, 2) = 0 'y position on tilesheet
TileIndex(8, 3) = 8 'itemid
TileIndexData(8, 0) = 1 'collision
TileIndexData(8, 1) = 1 'casts shadow
TileIndexData(8, 2) = 1 'blocks shadow
TileIndexData(8, 3) = 0 'has interior shadow
TileIndexData(8, 4) = 30 'resistance
TileIndexData(8, 5) = 1 'is solid


TileName(9, 0) = "Unlit Campfire" 'Name of the tile
TileName(9, 1) = "Placeholder" 'tooltip
TileIndex(9, 0) = 1 'layer definition
TileIndex(9, 1) = 144 'x position on tilesheet
TileIndex(9, 2) = 0 'y position on tilesheet
TileIndex(9, 3) = 9 'itemid
TileIndexData(9, 0) = 1 'collision
TileIndexData(9, 1) = 0 'casts shadow
TileIndexData(9, 2) = 1 'blocks shadow
TileIndexData(9, 3) = 0 'has interior shadow
TileIndexData(9, 4) = 15 'resistance
TileIndexData(9, 5) = 0 'is solid

TileName(10, 0) = "Campfire" 'Name of the tile
TileName(10, 1) = "Placeholder" 'tooltip
TileIndex(10, 0) = 1 'layer definition
TileIndex(10, 1) = 160 'x position on tilesheet
TileIndex(10, 2) = 0 'y position on tilesheet
TileIndex(10, 3) = 10 'itemid
TileIndexData(10, 0) = 1 'collision
TileIndexData(10, 1) = 0 'casts shadow
TileIndexData(10, 2) = 1 'blocks shadow
TileIndexData(10, 3) = 0 'has interior shadow
TileIndexData(10, 4) = 15 'resistance
TileIndexData(10, 5) = 0 'is solid
TileIndexData(10, 6) = 12 'light casts

TileName(11, 0) = "Ground Item" 'Name of the tile
TileName(11, 1) = "Placeholder" 'tooltip
TileIndex(11, 0) = 1 'layer definition
TileIndex(11, 1) = 176 'x position on tilesheet
TileIndex(11, 2) = 0 'y position on tilesheet
TileIndex(11, 3) = -1 'itemid
TileIndexData(11, 0) = 0 'collision
TileIndexData(11, 1) = 0 'casts shadow
TileIndexData(11, 2) = 0 'blocks shadow
TileIndexData(11, 3) = 0 'has interior shadow
TileIndexData(11, 4) = 0 'resistance
TileIndexData(11, 5) = 0 'is solid
TileIndexData(11, 6) = 0 'light casts
TileIndexData(11, 7) = 1 'is container
ContainerData(11, 0) = 0 'number of slots -1
ContainerData(11, 1) = 1 'dissapears on empty

TileName(12, 0) = "Berry Bush" 'Name of the tile
TileName(12, 1) = "Placeholder" 'tooltip
TileIndex(12, 0) = 1 'layer definition
TileIndex(12, 1) = 192 'x position on tilesheet
TileIndex(12, 2) = 0 'y position on tilesheet
TileIndex(12, 3) = 20 'itemid
TileIndexData(12, 0) = 1 'collision
TileIndexData(12, 1) = 0 'casts shadow
TileIndexData(12, 2) = 1 'blocks shadow
TileIndexData(12, 3) = 0 'has interior shadow
TileIndexData(12, 4) = 25 'resistance
TileIndexData(12, 5) = 0 'is solid


TileName(13, 0) = "Water"
TileName(13, 1) = ""
TileIndex(13, 0) = 0
TileIndex(13, 1) = 208 'x position on tilesheet
TileIndex(13, 2) = 0 'y position on tilesheet
TileIndex(13, 3) = -1 'itemid
TileIndexData(13, 0) = 0 'collision
TileIndexData(13, 1) = 0 'casts shadow
TileIndexData(13, 2) = 0 'blocks shadow
TileIndexData(13, 3) = 0 'has interior shadow
TileIndexData(13, 4) = 1000 'resistance
TileIndexData(13, 5) = 0 'is solid
TileIndexData(13, 9) = 0.04 'friction
TileIndexData(13, 10) = 0.4 'max speed
TileIndexData(13, 11) = 1 'tile spread

TileName(14, 0) = "Ice"
TileName(14, 1) = ""
TileIndex(14, 0) = 0
TileIndex(14, 1) = 224 'x position on tilesheet
TileIndex(14, 2) = 0 'y position on tilesheet
TileIndex(14, 3) = -1 'itemid
TileIndexData(14, 0) = 0 'collision
TileIndexData(14, 1) = 0 'casts shadow
TileIndexData(14, 2) = 0 'blocks shadow
TileIndexData(14, 3) = 0 'has interior shadow
TileIndexData(14, 4) = 19 'resistance
TileIndexData(14, 5) = 0 'is solid
TileIndexData(14, 9) = 0.01 'friction
TileIndexData(14, 10) = 2 'max speed
TileIndexData(14, 11) = 0 'tile spread

TileName(15, 0) = "Crafting Station" 'Name of the tile
TileName(15, 1) = "Placeholder" 'tooltip
TileIndex(15, 0) = 1 'layer definition
TileIndex(15, 1) = 240 'x position on tilesheet
TileIndex(15, 2) = 0 'y position on tilesheet
TileIndex(15, 3) = 21 'itemid
TileIndexData(15, 0) = 1 'collision
TileIndexData(15, 1) = 1 'casts shadow
TileIndexData(15, 2) = 1 'blocks shadow
TileIndexData(15, 3) = 0 'has interior shadow
TileIndexData(15, 4) = 25 'resistance
TileIndexData(15, 5) = 1 'is soli
TileIndexData(15, 8) = 3



TileName(16, 0) = "Wooden Ladder" 'Name of the tile
TileName(16, 1) = "Placeholder" 'tooltip
TileIndex(16, 0) = 0 'layer definition
TileIndex(16, 1) = 0 'x position on tilesheet
TileIndex(16, 2) = 16 'y position on tilesheet
TileIndex(16, 3) = 16 'itemid
TileIndexData(16, 0) = 1 'collision
TileIndexData(16, 1) = 0 'casts shadow
TileIndexData(16, 2) = 1 'blocks shadow
TileIndexData(16, 3) = 1 'has interior shadow
TileIndexData(16, 4) = 30 'resistance
TileIndexData(16, 5) = 1 'is solid
TileIndexData(16, 9) = 0.8 'Friction
TileIndexData(16, 10) = 0.8


'declare variable names and data types
Dim Shared Texture As Texture
Dim Shared File As File
Dim Shared Player As Character
Dim Shared Settings As Settings
Dim Shared Sounds As Sounds
Dim Shared Debug As Debug

'Constants
const TileParameters=13
const InvParameters=11
const EffectParameters=4
const MaxEffects=20

'Map Variables
Dim Shared GroundTile(41, 31) As Unsigned Integer
Dim Shared WallTile(41, 31) As Unsigned Integer
Dim Shared CeilingTile(41, 31) As Unsigned Integer
Dim Shared TileData(41, 31, tileparameters) As single
Dim Shared SpawnPointX As Single
Dim Shared SpawnPointY As Single
Dim Shared SavePointX As Single
Dim Shared SavePointY As Single

dim shared Container(20,invparameters)


Dim Shared SavedMapX As Integer64
Dim Shared SavedMapY As Integer64
Dim Shared SpawnMapX As Integer64
Dim Shared SpawnMapY As Integer64

Dim Shared MapX As Integer64
Dim Shared MapY As Integer64

Dim Shared WorldName As String
dim shared WorldSeed as integer64

Dim Shared GlobalLightLevel as byte
dim shared LocalLightLevel(41,31) as byte
dim shared OverlayLightLevel as byte

                                         dim shared GameTime as long
                                         dim shared TimeMode as byte

dim shared ScreenRezX
dim shared ScreenRezY

Dim Shared CurrentTick As Unsigned Integer64

dim shared OGLFPS as single

Dim Shared CameraPositionX As Single
Dim Shared CameraPositionY As Single

Dim Shared KeyPressed As Long

Dim Shared GameMode As Byte
Dim Shared DefaultRenderMode as Byte

Dim Shared Inventory(3, 5,invparameters)
dim shared CreativeInventory(2,5,invparameters,1)
dim shared CraftingGrid(5, 5,invparameters)
dim shared CraftingResult(invparameters)


Dim Shared Game.Title As String
Dim Shared Game.Version As String
Dim Shared Game.Buildinfo As String
Dim Shared Game.FCV As integer
Dim Shared Game.HostOS As String
Dim Shared Game.Designation As String
Dim Shared Game.32Bit as unsigned bit

Dim Shared perlin_octaves As Single, perlin_amp_falloff As Single

dim shared EffectArray(20,EffectParameters) as integer


'Flags
Dim Shared Flag.DebugMode As Unsigned Bit
Dim Shared Flag.ScreenRefreshSkip As Unsigned Bit
Dim Shared Flag.StillCam As Unsigned Bit
Dim Shared Flag.FullCam As Unsigned Bit
Dim Shared Flag.FreeCam As Unsigned Bit
Dim Shared Flag.NoClip As Unsigned Bit
Dim Shared Flag.FrameRateLock As Unsigned Bit
Dim Shared Flag.HudDisplay As Unsigned Bit
dim shared Flag.InventoryOpen as unsigned bit
dim shared Flag.CastShadows as unsigned bit
dim shared Flag.OpenCommand as byte
dim shared Flag.RenderOverride as unsigned bit
dim shared Flag.InitialRender as byte
dim shared Flag.ContainerOpen as unsigned bit
Dim Shared bgdraw As Unsigned Bit
dim shared RenderMode as byte

Dim Shared new As Unsigned Bit 'has not been updated, because might not exist


                             dim shared SwimOffset as byte


Type Debug
    Tracking As String
End Type





Dim Shared map.name As String
Dim Shared map.theme As Byte
Dim Shared map.foldername As String
Dim Shared map.filename As String
Dim Shared map.worldname As String
Dim Shared theme As Long
Dim Shared mapversion As String
Dim Shared prevfolder As String 'temp


Type File
    PlayerSprites As String
    TileSheet As String
    ItemSheet as string
    HudSprites As String
    Shadows As String
End Type

Type Texture
    PlayerSprites As Long
    TileSheet As Long
    ItemSheet as long
    HudSprites As Long
    Shadows As Long
End Type

Type Sounds
    error As String
    walk_grass as string
    damage_bush as string
    walk_water as string
End Type



Type Character
    x As Single
    y As Single
    lastx As Single
    lasty As Single
    vx as single
    vy as single

    tile As Byte
    tilefacing As Byte
    facing As Byte
    movingx As Byte
    movingy as byte
    type As Byte
    tilecontact as byte

    CraftingLevel as byte

    level As Byte
    health As Byte
    points As Byte
    experience As Long
    gold As Long

End Type



Type Settings
    FrameRate As Integer
    TickRate As Single
    FullScreen as byte
End Type





Sub NewWorld '(worldname as string, worldseed as integer64)
    Dim i, ii, iii
    Cls
    KeyClear
    AutoDisplay

    Input "World Name?", WorldName
    Input "World Seed? (0 for random)", WorldSeed

    If WorldSeed = 0 Then
        Randomize Using Timer
        WorldSeed = Ceil(Rnd * 18446744073709551615) - 9223372036854775807
    End If

    SavedMapX = -1
    SavedMapY = 0
    Player.x = 320
    Player.y = 200

    SAVEMAP 'necessary for at least 1 map to be saved before running generate map, because savemap is also responsible for creating the file structure for the world
    GenerateMap 'generates -1,0 so that its not just saving a completely empty map
    SAVEMAP 'saves that generated map

    Do 'generates the map that the player will actually spawn in, also checks to see if the player CAN even spawn in this map and is not in some ocean, if not it will try the next map over, the reason map -1,0 is generated first is so that this loop is cleaner
        SavedMapX = SavedMapX + 1
        GenerateMap
    Loop Until GroundTile(Int((Player.x + 8) / 16) + 1, Int((Player.y + 8) / 16) + 1) <> 13

    SpawnPointX = Player.x
    SpawnPointY = Player.y
    SpawnMapX = SavedMapX
    SpawnMapY = SavedMapY
    SAVEMAP 'saves only the map that the player will spawn on, why waste write cycles
    LOADWORLD
End Sub

Sub GenerateMap
    Dim i, ii, iii
    Dim PerlinTile As Double


    'if map is layer 0
    For i = 0 To 31
        For ii = 0 To 41

            'generate base tiles
            GroundTile(ii, i) = 2
            TileData(ii, i, 4) = 255
            WallTile(ii, i) = 1
            TileData(ii, i, 5) = 255
            CeilingTile(ii, i) = 1
            TileData(ii, i, 6) = 255


            'generate terrain
            PerlinTile = Perlin((ii + (SavedMapX * 40)) / 100, (i + (SavedMapY * 30)) / 100, 0, WorldSeed)
            Select Case PerlinTile
                Case Is < 0.35
                    GroundTile(ii, i) = 13
            End Select
        Next
    Next
    Randomize Using Val(Str$(SavedMapX)) + Val(Str$(SavedMapY)) + Val(Str$(WorldSeed)) 'TODO, include world layer in this too
    For i = 0 To 31
        For ii = 0 To 41


            If GroundTile(ii, i) <> 13 Then

                'generate bushes
                If Ceil(Rnd * 10) = 5 Then
                    WallTile(ii, i) = 5
                End If

                'generate ground wood items
                If Ceil(Rnd * 100) = 50 Then
                    WallTile(ii, i) = 11
                    NewContainer SavedMapX, SavedMapY, ii, i
                    OpenContainer SavedMapX, SavedMapY, ii, i
                    For iii = 0 To InvParameters
                        Container(0, iii) = ItemIndex(19, iii)
                    Next
                    Container(0, 7) = Ceil(Rnd * 3)
                    CloseContainer SavedMapX, SavedMapY, ii, i
                End If

                'generate berry bushes
                If Ceil(Rnd * 500) = 250 Then
                    WallTile(ii, i) = 12
                End If
            End If

            'update set tiles
            UpdateTile ii, i
        Next
    Next
End Sub

 
